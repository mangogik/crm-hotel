import{j as e,b as be,r as u,c as ss,u as ts}from"./app-AyfoWOf7.js";import{c as $e,B as L}from"./button-BQewrBSE.js";import{b as ye,c as we,C as ce,d as oe,a as Be}from"./card-AZOavDqy.js";import{S as as,A as ns,D as _e,b as Se,c as ke,d as Ce,e as Ae,f as De}from"./dialog-CXcK20gv.js";import{B as Oe}from"./badge-Iuivjzy_.js";import{P as rs,T as is,t as je}from"./index-uF_CP_2T.js";import{X as ze,d as ls,A as cs}from"./AuthenticatedLayout-CWdU4vaa.js";import{D as os}from"./dollar-sign-C86JtohX.js";import{A as ds,P as ms}from"./package-CA89VVLL.js";import{P as Qe}from"./plus-0Qvt8Q3j.js";import{I as fe,L as Y}from"./label-DD35oVQK.js";import{S as V,a as z,b as Q,c as I,d as j}from"./select-vsK93IMx.js";import{F as Ne}from"./funnel-DzxNHDw1.js";import{T as le,a as T,b as Ie,c as He,d as K,e as Ue}from"./table-CyulltmA.js";import{S as us}from"./scroll-area-CIVouAEN.js";import{C as hs}from"./chevron-down-DEv-iym4.js";import{U as xs}from"./users-BGBP2Elj.js";import{M as ps}from"./message-square-DQQVtyQh.js";import{C as gs}from"./checkbox-BhbQ1Usz.js";import{T as js}from"./textarea-B4AeXW3p.js";import{L as fs}from"./loader-circle-C1QjoT64.js";import{C as Re}from"./circle-question-mark-CwP9f6HV.js";/* empty css            */import"./index-DaYjVfwV.js";import"./index-DSwpZHfu.js";import"./index-kg_FVPZ1.js";/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ns=[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 18h.01",key:"lrp35t"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M16 18h.01",key:"kzsmim"}]],vs=$e("calendar-days",Ns);/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bs=[["path",{d:"M12 6v6l4 2",key:"mmk7yg"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],ys=$e("clock",bs);/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ws=[["path",{d:"M16 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8Z",key:"qazsjp"}],["path",{d:"M15 3v4a2 2 0 0 0 2 2h4",key:"40519r"}]],_s=$e("sticky-note",ws),ve=t=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(t||0),Ss=({onAddOrder:t,totals:r={}})=>{r?.total_orders;const i=r?.today_orders??0,p=r?.paid_amount??0,g=r?.pending_amount??0,f=r?.avg_order_value??0,A=[{title:"Paid Amount",value:ve(p),icon:os,color:"text-green-600",bgColor:"bg-green-100",borderColor:"border-green-200"},{title:"Pending Amount",value:ve(g),icon:ys,color:"text-amber-600",bgColor:"bg-amber-100",borderColor:"border-amber-200"},{title:"Orders Today",value:i?.toLocaleString?.("id-ID")??i,icon:vs,color:"text-blue-600",bgColor:"bg-blue-100",borderColor:"border-blue-200"},{title:"Avg Order Value",value:ve(f),icon:ds,color:"text-indigo-600",bgColor:"bg-indigo-100",borderColor:"border-indigo-200"}];return e.jsxs("div",{className:"pb-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx(ye,{className:"text-2xl font-bold",children:"Orders"}),e.jsx(we,{children:"Manage customer orders"})]}),e.jsxs(L,{onClick:t,className:"flex items-center gap-2",children:[e.jsx(Qe,{className:"h-4 w-4"})," Add Order"]})]}),e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4 pt-6 w-full",children:A.map((o,D)=>e.jsx(ce,{className:`p-2 gap-1 border-b-8 ${o.borderColor}`,children:e.jsx(oe,{className:"p-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-muted-foreground",children:o.title}),e.jsx("div",{className:"text-2xl font-bold",children:o.value})]}),e.jsx("div",{className:`rounded-full p-2 border-2 ${o.bgColor}`,children:e.jsx(o.icon,{className:`h-5 w-5 ${o.color}`})})]})})},D))})]})},ks=({searchTerm:t,setSearchTerm:r,selectedStatus:i,setSelectedStatus:p,selectedPaymentMethod:g,setSelectedPaymentMethod:f,selectedCountry:A,setSelectedCountry:o,clearFilters:D,countries:O})=>e.jsx(ce,{className:" mb-6",children:e.jsx(oe,{children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(as,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4"}),e.jsx(fe,{placeholder:"Search orders...",value:t,onChange:P=>r(P.target.value),className:"pl-10"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(V,{value:i,onValueChange:p,children:[e.jsxs(z,{className:"w-[180px]",children:[e.jsx(Ne,{className:"mr-2 h-4 w-4"}),e.jsx(Q,{placeholder:"Status"})]}),e.jsxs(I,{children:[e.jsx(j,{value:"all",children:"All Statuses"}),e.jsx(j,{value:"pending",children:"Pending"}),e.jsx(j,{value:"paid",children:"Paid"}),e.jsx(j,{value:"cancelled",children:"Cancelled"})]})]}),e.jsxs(V,{value:A,onValueChange:o,children:[e.jsxs(z,{className:"w-[180px]",children:[e.jsx(Ne,{className:"mr-2 h-4 w-4"}),e.jsx(Q,{placeholder:"Country"})]}),e.jsxs(I,{children:[e.jsx(j,{value:"all",children:"All Countries"}),O.map(P=>e.jsx(j,{value:P,children:P},P))]})]}),e.jsxs(V,{value:g,onValueChange:f,children:[e.jsxs(z,{className:"w-[180px]",children:[e.jsx(Ne,{className:"mr-2 h-4 w-4"}),e.jsx(Q,{placeholder:"Payment"})]}),e.jsxs(I,{children:[e.jsx(j,{value:"all",children:"All Payments"}),e.jsx(j,{value:"cash",children:"Cash"}),e.jsx(j,{value:"online",children:"Online"})]})]}),e.jsxs(L,{variant:"outline",onClick:D,className:"flex items-center gap-2",children:[e.jsx(ze,{className:"h-4 w-4"})," Clear Sort & Filters"]})]})]})})}),Cs=({order:t,isExpanded:r,onToggle:i,onEdit:p,onDelete:g,getStatusBadge:f,getPaymentBadge:A,formatPrice:o,formatDate:D})=>{const O=t.status==="pending",P=n=>{n.stopPropagation(),O?p():je.info("Pesanan ini telah diproses dan tidak dapat diubah.")},E=n=>{n.stopPropagation(),g()},S=(n,v,h=void 0)=>{try{return v.split(".").reduce((d,w)=>d==null?d:d[w],n)??h}catch{return h}},y=n=>{if(!n)return null;if(typeof n=="object")return n;try{return JSON.parse(n)}catch{return null}},$=(()=>{const n=new Map;return(Array.isArray(t.services)?t.services:[]).forEach(h=>{const d=y(S(h,"pivot.answers_json",null)),w=S(h,"active_question.questions_json",null),s=Array.isArray(d?.questions_snapshot)?d.questions_snapshot:Array.isArray(w)?w:[],l=Array.isArray(d?.answers)?d.answers:[];(s.length||l.length)&&n.set(Number(h.id),{questions:s,answers:l})}),n})(),q=(Array.isArray(t.services)?t.services:[]).map(n=>{const v=Number(S(n,"pivot.quantity",0)),h=Number(S(n,"pivot.price_per_unit",0));return{id:Number(n.id),name:n.name,qty:v,base:v*h}}),B=Number(t?.discount_total||0),U=Array.isArray(t?.promotions)&&t.promotions[0]||null;let J=null;U&&B>0&&Array.isArray(U.services)&&(J=U.services.length>0?new Set(U.services.map(n=>Number(n.id))):new Set(q.map(n=>n.id)));let M=[];if(B>0&&J){const v=q.filter(h=>J.has(h.id)).reduce((h,d)=>h+d.base,0);M=q.map(h=>{let d=0;if(J.has(h.id)&&v>0){const w=h.base/v;d=B*w}return{id:h.id,name:h.name,qty:h.qty,lineSubtotal:h.base,lineDiscount:d,lineTotal:h.base-d}})}else M=q.map(n=>({id:n.id,name:n.name,qty:n.qty,lineSubtotal:n.base,lineDiscount:0,lineTotal:n.base}));const Z=M.reduce((n,v)=>n+v.lineSubtotal,0),X=M.reduce((n,v)=>n+v.lineDiscount,0),ee=Z-X,se=$.size>0,te=typeof t.notes=="string"&&t.notes.trim().length>0;return e.jsxs(e.Fragment,{children:[e.jsxs(le,{className:"cursor-pointer hover:bg-muted/50 transition-colors",onClick:i,children:[e.jsx(T,{className:"w-10",children:e.jsx(L,{variant:"ghost",size:"sm",children:r?e.jsx(hs,{className:"h-4 w-4"}):e.jsx(ls,{className:"h-4 w-4"})})}),e.jsx(T,{className:"font-medium",children:t.customer.name}),e.jsx(T,{children:t.customer.passport_country?e.jsx(Oe,{variant:"outline",children:t.customer.passport_country}):"N/A"}),e.jsx(T,{children:f(t.status)}),e.jsx(T,{children:A(t.payment_preference)}),e.jsx(T,{className:"font-medium",children:o(ee)}),e.jsx(T,{children:D(t.updated_at)}),e.jsx(T,{onClick:n=>n.stopPropagation(),children:e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(L,{variant:"ghost",size:"sm",onClick:P,className:O?"bg-secondary text-secondary-foreground":"hidden",children:e.jsx(rs,{className:"h-4 w-4"})}),e.jsx(L,{variant:"ghost",size:"sm",onClick:E,className:"bg-destructive text-destructive-foreground",children:e.jsx(is,{className:"h-4 w-4"})})]})})]}),r&&e.jsx(le,{children:e.jsx(T,{colSpan:8,className:"p-0",children:e.jsxs("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 p-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4",children:[e.jsxs("div",{className:"flex flex-col gap-4 md:col-span-2",children:[e.jsxs("div",{className:"bg-white rounded-lg p-4 shadow-sm border border-slate-100m flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("div",{className:"bg-blue-100 p-1.5 rounded-full",children:e.jsx(xs,{className:"h-4 w-4 text-blue-600"})}),e.jsx("h3",{className:"text-sm font-semibold text-slate-800",children:"Customer"})]}),e.jsxs("div",{className:"space-y-2 text-[13px] leading-relaxed",children:[e.jsxs("div",{className:"flex",children:[e.jsx("span",{className:"font-medium w-20 text-slate-600",children:"Name"}),e.jsx("span",{className:"text-slate-800",children:t.customer.name})]}),e.jsxs("div",{className:"flex",children:[e.jsx("span",{className:"font-medium w-20 text-slate-600",children:"Email"}),e.jsx("span",{className:"text-slate-800",children:t.customer.email||"N/A"})]}),e.jsxs("div",{className:"flex",children:[e.jsx("span",{className:"font-medium w-20 text-slate-600",children:"Phone"}),e.jsx("span",{className:"text-slate-800",children:t.customer.phone||"N/A"})]}),e.jsxs("div",{className:"flex",children:[e.jsx("span",{className:"font-medium w-20 text-slate-600",children:"Country"}),e.jsx("span",{className:"text-slate-800",children:t.customer.passport_country||"N/A"})]})]})]}),te&&e.jsxs("div",{className:"bg-white rounded-lg p-4 shadow-sm border border-slate-100 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("div",{className:"bg-yellow-100 p-1.5 rounded-full",children:e.jsx(_s,{className:"h-4 w-4 text-yellow-700"})}),e.jsx("h3",{className:"text-sm font-semibold text-slate-800",children:"Order Notes"})]}),e.jsx("div",{className:"text-[13px] leading-relaxed text-slate-700 whitespace-pre-line break-words",children:t.notes})]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 shadow-sm md:col-span-3 border border-slate-100",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("div",{className:"bg-green-100 p-1.5 rounded-full",children:e.jsx(ms,{className:"h-4 w-4 text-green-600"})}),e.jsx("h3",{className:"text-sm font-semibold text-slate-800",children:"Pricing"})]}),M.length>0&&e.jsx("div",{className:"border rounded-md bg-background overflow-hidden",children:e.jsx(us,{className:"h-40",children:e.jsxs(Ie,{className:"text-[13px]",children:[e.jsx(He,{className:"bg-slate-50/60",children:e.jsxs(le,{children:[e.jsx(K,{className:"w-2/5 py-2",children:"Service"}),e.jsx(K,{className:"py-2",children:"Qty"}),e.jsx(K,{className:"py-2",children:"Subtotal"}),e.jsx(K,{className:"py-2",children:"Disc"}),e.jsx(K,{className:"text-right py-2",children:"Total"})]})}),e.jsx(Ue,{children:M.map(n=>e.jsxs(le,{children:[e.jsx(T,{className:"py-2 align-top",children:e.jsx("div",{className:"font-medium text-slate-800",children:n.name})}),e.jsx(T,{className:"py-2 align-top text-slate-700",children:n.qty}),e.jsx(T,{className:"py-2 align-top text-slate-700",children:o(n.lineSubtotal)}),e.jsx(T,{className:"py-2 align-top text-red-600",children:n.lineDiscount>0?`− ${o(n.lineDiscount)}`:"—"}),e.jsx(T,{className:"py-2 align-top text-right font-medium text-slate-900",children:o(n.lineTotal)})]},n.id))})]})})}),e.jsxs("div",{className:"space-y-1.5 mt-3 text-[13px]",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-slate-600",children:"Subtotal"}),e.jsx("span",{className:"font-medium text-slate-900",children:o(Z)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-slate-600",children:"Discount"}),e.jsx("span",{className:"font-medium text-red-600",children:X>0?`− ${o(X)}`:"—"})]}),e.jsxs("div",{className:"border-t pt-2 mt-2 flex justify-between",children:[e.jsx("span",{className:"text-slate-800 font-semibold",children:"Grand Total"}),e.jsx("span",{className:"font-semibold text-slate-900",children:o(ee)})]})]})]})]}),se&&e.jsxs("div",{className:"mt-4 bg-white rounded-lg p-4 shadow-sm border border-slate-100",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("div",{className:"bg-purple-100 p-1.5 rounded-full",children:e.jsx(ps,{className:"h-4 w-4 text-purple-600"})}),e.jsx("h3",{className:"text-sm font-semibold text-slate-800",children:"Questions & Answers"})]}),e.jsx("div",{className:"space-y-3",children:Array.from($.entries()).map(([n,v])=>{const h=t.services.find(d=>Number(d.id)===n);return h?e.jsxs("div",{className:"border rounded-md p-3 bg-muted/20 text-[13px] leading-relaxed",children:[e.jsx("h4",{className:"font-medium text-slate-800 mb-2",children:h.name}),v.questions.length>0?e.jsx("div",{className:"space-y-2",children:v.questions.map((d,w)=>{const s=v.answers[w]||"Not answered";return e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-12 gap-2 md:gap-4",children:[e.jsxs("div",{className:"md:col-span-5",children:[e.jsx("div",{className:"text-[11px] font-medium text-muted-foreground leading-none mb-1 flex items-start gap-1",children:e.jsx("span",{children:"Question"})}),e.jsx("div",{className:"text-[13px] font-medium text-slate-800 leading-snug break-words whitespace-pre-line",children:d})]}),e.jsxs("div",{className:"md:col-span-7",children:[e.jsx("div",{className:"text-[11px] font-medium text-muted-foreground leading-none mb-1 flex items-start gap-1",children:e.jsx("span",{children:"Answer"})}),e.jsx("div",{className:"text-[13px] text-slate-700 leading-snug break-words whitespace-pre-line",children:s})]})]},w)})}):e.jsx("div",{className:"text-[13px] text-muted-foreground",children:"No questions for this service."})]},n):null})})]})]})})},`${t.id}-details`)]})},As=({orders:t,expandedRows:r,toggleRow:i,openEditModal:p,openDeleteModal:g,getStatusBadge:f,getPaymentBadge:A,formatPrice:o,formatDate:D,sortBy:O,sortDirection:P,handleSort:E})=>{const S=({field:y,children:$})=>e.jsx(K,{className:"cursor-pointer",onClick:()=>E(y),children:e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("span",{children:$}),O===y&&e.jsx(ns,{className:`h-3 w-3 ${P==="asc"?"rotate-180":""}`})]})});return e.jsx("div",{className:"rounded-md border",children:e.jsxs(Ie,{children:[e.jsx(He,{children:e.jsxs(le,{children:[e.jsx(K,{className:"w-8"}),e.jsx(S,{field:"customer.name",children:"Customer"}),e.jsx(K,{children:"Country"}),e.jsx(S,{field:"status",children:"Status"}),e.jsx(S,{field:"payment_preference",children:"Payment"}),e.jsx(K,{children:"Total"}),e.jsx(S,{field:"created_at",children:"Date"}),e.jsx(K,{children:"Actions"})]})}),e.jsx(Ue,{children:t.length>0?t.map(y=>e.jsx(Cs,{order:y,isExpanded:r.includes(y.id),onToggle:()=>i(y.id),onEdit:()=>p(y),onDelete:()=>g(y),getStatusBadge:f,getPaymentBadge:A,formatPrice:o,formatDate:D},y.id)):e.jsx(le,{children:e.jsx(T,{colSpan:8,className:"text-center py-8",children:"No orders found"})})})]})})},Ds=({isOpen:t,onOpenChange:r,onConfirm:i,order:p})=>p?e.jsx(_e,{open:t,onOpenChange:r,children:e.jsxs(Se,{children:[e.jsxs(ke,{children:[e.jsx(Ce,{children:"Confirm Deletion"}),e.jsxs(Ae,{children:["Are you sure you want to delete the order for"," ",e.jsx("strong",{children:p.customer.name}),"? This action cannot be undone."]})]}),e.jsxs(De,{children:[e.jsx(L,{variant:"outline",onClick:()=>r(!1),children:"Cancel"}),e.jsx(L,{variant:"destructive",onClick:i,children:"Delete"})]})]})}):null,Os=({paginationData:t,buildPaginationUrl:r})=>{const{from:i,to:p,total:g,prev_page_url:f,next_page_url:A}=t,o=D=>{D&&be.get(r(D),{},{preserveState:!0,replace:!0})};return e.jsxs("div",{className:"flex items-center justify-between mt-6",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Showing ",i," to ",p," of ",g," results"]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(L,{variant:"outline",size:"sm",onClick:()=>o(f),disabled:!f,children:"Previous"}),e.jsx(L,{variant:"outline",size:"sm",onClick:()=>o(A),disabled:!A,children:"Next"})]})]})},Pe=t=>!t&&t!==0?"N/A":new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR"}).format(t);function Ps(t){const r=t?.options;if(!r)return[];if(Array.isArray(r))return r;try{const i=JSON.parse(r);return Array.isArray(i)?i:[]}catch{return[]}}function $s(t,r){const i=[];if(t.discount_percent&&i.push(`${t.discount_percent}% off`),t.discount_amount&&i.push(`${Pe(Number(t.discount_amount))} off`),t.free_service_id){const g=r?.[t.free_service_id]?.name||`Service #${t.free_service_id}`,f=t.free_service_qty||1;i.push(`Free: ${g} × ${f}`)}const p=i.length?i.join(" • "):"Special offer";return`${t.name} (${t.type}) — ${p}`}function qs(t){if(!t)return null;const r=String(t).toLowerCase();return["reserved"].includes(r)?new Set(["pre_checkin"]):["checked_in"].includes(r)?new Set(["post_checkin","pre_checkout"]):null}const Ve=({data:t,setData:r,errors:i,customers:p,services:g,orderServices:f,updateService:A,updateServiceDetail:o,addService:D,removeService:O,isPending:P=!0,isStatusUpdateOnly:E=!1,eligiblePromos:S=[],checkingPromo:y=!1})=>{const $=!E,H=(g||[]).reduce((s,l)=>(s[l.id]=l,s),{}),[q,B]=u.useState([]),[U,J]=u.useState(!1),[M,Z]=u.useState(""),X=u.useMemo(()=>{if(!t.booking_id)return null;const s=Number(t.booking_id);return q.find(l=>Number(l.id)===s)||null},[t.booking_id,q]),ee=u.useMemo(()=>qs(X?.status),[X]),se=u.useMemo(()=>!Array.isArray(g)||g.length===0?[]:ee?g.filter(s=>ee.has(s.offering_session)):g,[g,ee]),[te,n]=u.useState({}),[v,h]=u.useState({}),[d,w]=u.useState(new Set);return u.useEffect(()=>{if(!$)return;const s=async(x,W)=>{if(x){h(b=>({...b,[x]:!0}));try{const b=await fetch(`/api/services/${x}/questions`);if(b.ok){const C=await b.json();n(F=>({...F,[x]:C}));const ae=f[W]?.details?.answers||[];if(ae.length!==C.length){const F=Array(C.length).fill("");ae.forEach((re,ne)=>{ne<C.length&&(F[ne]=re)}),o(W,"answers",F)}}}catch(b){console.error("Error fetching questions:",b)}finally{h(b=>({...b,[x]:!1}))}}},k=f.map(x=>x.id).filter(Boolean).filter(x=>!d.has(x));k.length>0&&(w(x=>new Set([...x,...k])),f.forEach((x,W)=>{x.id&&k.includes(x.id)&&s(x.id,W)}))},[f,$,d,o]),u.useEffect(()=>{$||(w(new Set),n({}))},[$]),u.useEffect(()=>{if(!$)return;const s=t.customer_id;if(t.booking_id&&r("booking_id",""),!s){B([]),Z("");return}let l=!1;return(async()=>{try{J(!0),Z("");const k=await fetch(`/api/customers/${s}/bookings?onlyActive=1`,{credentials:"same-origin",headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"}});if(!k.ok)throw new Error(`HTTP ${k.status}`);const x=await k.json();if(l)return;B(Array.isArray(x.bookings)?x.bookings:[])}catch{l||(Z("Failed to load bookings for this customer."),B([]))}finally{l||J(!1)}})(),()=>{l=!0}},[$,t.customer_id]),E?e.jsxs("div",{className:"text-sm py-2",children:[e.jsxs("div",{className:"grid grid-cols-5 gap-3 items-center",children:[e.jsx(Y,{htmlFor:"status",className:"col-span-2 text-right",children:"Status *"}),e.jsxs("div",{className:"col-span-3",children:[e.jsxs(V,{value:t.status,onValueChange:s=>r("status",s),children:[e.jsx(z,{className:"h-8 py-1 px-2",children:e.jsx(Q,{placeholder:"Select status"})}),e.jsxs(I,{children:[e.jsx(j,{value:"pending",children:"Pending"}),e.jsx(j,{value:"paid",children:"Paid"}),e.jsx(j,{value:"cancelled",children:"Cancelled"})]})]}),i.status&&e.jsx("p",{className:"mt-1 text-xs text-destructive",children:i.status})]})]}),e.jsxs("div",{className:"mt-3 grid grid-cols-5 gap-3 items-center",children:[e.jsx(Y,{htmlFor:"payment_preference",className:"col-span-2 text-right",children:"Payment Method *"}),e.jsxs("div",{className:"col-span-3",children:[e.jsxs(V,{value:t.payment_preference,onValueChange:s=>r("payment_preference",s),children:[e.jsx(z,{className:"h-8 py-1 px-2",children:e.jsx(Q,{placeholder:"Select payment method"})}),e.jsxs(I,{children:[e.jsx(j,{value:"cash",children:"Cash"}),e.jsx(j,{value:"online",children:"Online"})]})]}),i.payment_preference&&e.jsx("p",{className:"mt-1 text-xs text-destructive",children:i.payment_preference})]})]})]}):e.jsx("div",{className:"grid gap-4 py-3 w-full max-w-none mx-auto px-3 sm:px-4 text-sm",children:$&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-8",children:[e.jsxs(ce,{children:[e.jsxs(Be,{className:"",children:[e.jsx(ye,{children:"Order Information"}),e.jsx(we,{children:"Customer and order details"})]}),e.jsxs(oe,{className:"space-y-4 p-6 pt-0",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Y,{htmlFor:"customer_id",className:"text-right",children:"Customer *"}),e.jsxs(V,{value:t.customer_id,onValueChange:s=>r("customer_id",s),children:[e.jsx(z,{className:"col-span-3",children:e.jsx(Q,{placeholder:"Select customer"})}),e.jsx(I,{children:p.map(s=>e.jsx(j,{value:s.id.toString(),children:s.name},s.id))})]}),i.customer_id&&e.jsx("p",{className:"text-destructive text-sm col-span-4 text-right",children:i.customer_id})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Y,{htmlFor:"booking_id",className:"text-right",children:"Booking"}),e.jsxs("div",{className:"col-span-3 space-y-1 min-w-0",children:[e.jsxs(V,{value:t.booking_id||"",onValueChange:s=>r("booking_id",s),disabled:!t.customer_id||U||q.length===0,children:[e.jsx(z,{className:"min-w-0 w-full [&>span]:block [&>span]:truncate",title:(()=>{if(!t.booking_id)return;const s=q.find(l=>String(l.id)===String(t.booking_id));if(s)return s.room_label?`${s.room_label} • ${s.status} • ${new Date(s.checkin_at).toLocaleDateString()} - ${new Date(s.checkout_at).toLocaleDateString()}`:`Booking #${s.id} • ${s.status}`})(),children:e.jsx(Q,{placeholder:t.customer_id?U?"Loading bookings…":q.length?"Select booking":"No active bookings":"Select customer first"})}),e.jsx(I,{children:q.map(s=>{const l=s.room_label?`${s.room_label} • ${s.status} • ${new Date(s.checkin_at).toLocaleDateString()} - ${new Date(s.checkout_at).toLocaleDateString()}`:`Booking #${s.id} • ${s.status}`;return e.jsx(j,{value:String(s.id),className:"whitespace-normal break-words leading-snug py-2",title:l,children:l},s.id)})})]}),M&&e.jsx("p",{className:"text-xs text-destructive",children:M}),!M&&t.customer_id&&q.length===0&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"This customer has no active bookings. You may leave it blank."}),!t.customer_id&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"Pick a customer to choose a booking."})]})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Y,{className:"text-right",children:"Promotion"}),e.jsxs("div",{className:"col-span-3 space-y-2",children:[e.jsxs(V,{value:t.promotion_id||"",onValueChange:s=>r("promotion_id",s),disabled:y||S.length===0,children:[e.jsx(z,{children:e.jsx(Q,{placeholder:y?"Checking promotions…":S.length?"Select a promotion":"No promotion available"})}),e.jsx(I,{children:S.map(s=>e.jsx(j,{value:String(s.id),children:$s(s,H)},s.id))})]}),i.promotion_id&&e.jsx("p",{className:"text-destructive text-sm",children:i.promotion_id})]})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Y,{htmlFor:"status",className:"text-right",children:"Status *"}),e.jsxs(V,{value:t.status,onValueChange:s=>r("status",s),children:[e.jsx(z,{className:"col-span-3",children:e.jsx(Q,{placeholder:"Select status"})}),e.jsxs(I,{children:[e.jsx(j,{value:"pending",children:"Pending"}),e.jsx(j,{value:"paid",children:"Paid"}),e.jsx(j,{value:"cancelled",children:"Cancelled"})]})]}),i.status&&e.jsx("p",{className:"text-destructive text-sm col-span-4 text-right",children:i.status})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Y,{htmlFor:"payment_preference",className:"",children:"Payment Method *"}),e.jsxs(V,{value:t.payment_preference,onValueChange:s=>r("payment_preference",s),disabled:!P,children:[e.jsx(z,{className:"col-span-3",children:e.jsx(Q,{placeholder:"Select payment method"})}),e.jsxs(I,{children:[e.jsx(j,{value:"cash",children:"Cash"}),e.jsx(j,{value:"online",children:"Online"})]})]}),i.payment_preference&&e.jsx("p",{className:"text-destructive text-sm col-span-4 text-right",children:i.payment_preference})]}),e.jsxs("div",{className:"grid grid-cols-4 gap-4",children:[e.jsx(Y,{htmlFor:"order_notes",className:"text-right",children:"Notes"}),e.jsxs("div",{className:"col-span-3 space-y-1",children:[e.jsx(js,{id:"order_notes",placeholder:"Ex: Deliver after 7 PM, knock softly, guest will pay at checkout.",className:"min-h-[70px] resize-y",value:t.order_notes||"",onChange:s=>r("order_notes",s.target.value)}),i.order_notes&&e.jsx("p",{className:"text-destructive text-sm",children:i.order_notes})]})]})]})]}),e.jsxs(ce,{className:"",children:[e.jsxs(Be,{children:[e.jsx(ye,{children:"Services"}),e.jsx(we,{children:"Add services to this order"})]}),e.jsx(oe,{children:e.jsx("div",{className:"overflow-auto pr-2 max-h-[clamp(200px,45vh,380px)]",children:e.jsx("fieldset",{disabled:!P,className:"space-y-4",children:e.jsxs("div",{className:"space-y-4",children:[f.map((s,l)=>{const k=se.find(m=>String(m.id)===String(s.id)),x=Ps(k||H[s.id]),W=k?.type||H[s.id]?.type,b=W==="selectable",C=W==="multiple_options",ae=W==="per_unit",F=k?.unit_name||H[s.id]?.unit_name||"",re=b&&!s?.details?.package,ne=ae&&(s?.details?.weight===void 0||s?.details?.weight===null||s?.details?.weight===""||Number.isNaN(Number(s?.details?.weight))),ie=te[s.id]||[],de=ie.length>0,me=v[s.id];return e.jsx(ce,{className:"border border-border",children:e.jsxs(oe,{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h4",{className:"font-medium",children:["Service #",l+1]}),f.length>1&&e.jsx(L,{type:"button",variant:"outline",size:"sm",onClick:()=>O(l),children:e.jsx(ze,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"grid grid-cols-12 gap-2",children:[e.jsx("div",{className:"col-span-7",children:e.jsxs(V,{value:s.id,onValueChange:m=>A(l,"id",m),children:[e.jsx(z,{children:e.jsx(Q,{placeholder:"Select service"})}),e.jsx(I,{children:se.map(m=>e.jsx(j,{value:m.id.toString(),children:m.name},m.id))})]})}),e.jsx("div",{className:"col-span-5",children:e.jsx(fe,{type:"number",min:"1",placeholder:"Quantity",value:s.quantity,onChange:m=>A(l,"quantity",parseInt(m.target.value)||1)})})]}),k&&e.jsxs(e.Fragment,{children:[b&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs(V,{value:s?.details?.package||"",onValueChange:m=>o(l,"package",m),children:[e.jsx(z,{children:e.jsx(Q,{placeholder:"Select option"})}),e.jsx(I,{children:x.map((m,R)=>e.jsxs(j,{value:m.name,children:[m.name," — ",Pe(Number(m.price))]},R))})]}),re?e.jsx("p",{className:"text-xs text-destructive",children:"Option is required for this service."}):e.jsx("p",{className:"text-xs text-muted-foreground",children:"Choose package/variant."})]}),C&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"max-h-40 overflow-auto rounded-md border border-border p-2",children:x.length?x.map((m,R)=>{const ue=Array.isArray(s?.details?.packages)?s.details.packages.includes(m.name):!1;return e.jsxs("div",{className:"flex items-center justify-between gap-3 py-1 px-2 rounded hover:bg-muted/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(gs,{id:`svc-${l}-opt-${R}`,checked:ue,onCheckedChange:he=>{const G=Array.isArray(s?.details?.packages)?[...s.details.packages]:[];if(he)G.includes(m.name)||G.push(m.name);else{const xe=G.indexOf(m.name);xe>=0&&G.splice(xe,1)}o(l,"packages",G)}}),e.jsx(Y,{htmlFor:`svc-${l}-opt-${R}`,className:"text-sm font-normal cursor-pointer",children:m.name})]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:Pe(Number(m.price))})]},R)}):e.jsx("div",{className:"text-xs text-muted-foreground",children:"No options configured."})}),!s?.details?.packages||s.details.packages.length===0?e.jsx("p",{className:"text-xs text-destructive",children:"Pick at least one option."}):e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Selected: ",s.details.packages.join(", ")]})]}),ae&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(fe,{type:"number",min:"0",step:"0.01",placeholder:F?`Amount (${F})`:"Amount",value:s?.details?.weight??"",onChange:m=>o(l,"weight",m.target.value===""?"":parseFloat(m.target.value)||0)}),F&&e.jsx("span",{className:"text-sm text-muted-foreground",children:F})]}),ne?e.jsx("p",{className:"text-xs text-destructive",children:F?`${F} is required.`:"Amount is required."}):e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Enter the ",F||"amount"," for this service."]})]}),k&&e.jsxs("div",{className:"space-y-3",children:[me&&e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-muted rounded-lg border border-border",children:[e.jsx(fs,{className:"h-4 w-4 animate-spin text-primary"}),e.jsx("span",{className:"text-sm text-foreground",children:"Loading questions..."})]}),!me&&de&&e.jsxs("div",{className:"p-3 bg-muted rounded-lg border border-border",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Re,{className:"h-4 w-4 text-foreground"}),e.jsx("h5",{className:"font-medium text-sm text-foreground",children:"Please answer these questions:"})]}),ie.map((m,R)=>e.jsx("div",{className:"space-y-1",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("div",{className:"flex-shrink-0 mt-1",children:e.jsx("div",{className:"flex items-center justify-center h-5 w-5 rounded-full bg-primary text-primary-foreground text-xs font-medium",children:R+1})}),e.jsxs("div",{className:"flex-1",children:[e.jsx(Y,{className:"text-sm font-medium text-foreground",children:m}),e.jsx(fe,{placeholder:"Your answer...",value:s?.details?.answers?.[R]||"",onChange:ue=>{const G=[...s?.details?.answers||[]];G[R]=ue.target.value,o(l,"answers",G)},className:"mt-1"})]})]})},R))]}),!me&&!de&&d.has(s.id)&&e.jsx("div",{className:"p-3 bg-muted rounded-lg border border-border",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Re,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"No questions required for this service"})]})})]})]})]})},l)}),e.jsxs(L,{type:"button",variant:"outline",size:"sm",onClick:D,className:"w-full",children:[e.jsx(Qe,{className:"h-4 w-4 mr-1"})," Add Service"]}),i.services&&e.jsx("p",{className:"text-destructive text-sm",children:i.services})]})})})})]})]})})})};function Ts(){const{orders:t,customers:r,services:i,filters:p,flash:g,totals:f}=ss().props,A=[...new Set(r.map(a=>a.passport_country).filter(Boolean))],[o,D]=u.useState(p.search||""),[O,P]=u.useState(p.status||"all"),[E,S]=u.useState(p.payment_preference||"all"),[y,$]=u.useState(p.country||"all"),[H,q]=u.useState(p.sort_by||"created_at"),[B,U]=u.useState(p.sort_direction||"desc"),[J,M]=u.useState(!1),[Z,X]=u.useState(!1),[ee,se]=u.useState(!1),[te,n]=u.useState(null),[v,h]=u.useState([]),[d,w]=u.useState([{id:"",quantity:1,details:{}}]),[s,l]=u.useState([]),[k,x]=u.useState(!1),W=te?.status==="pending",{data:b,setData:C,post:ae,put:F,processing:re,errors:ne,reset:ie,clearErrors:de}=ts({customer_id:"",services:[{id:"",quantity:1,details:{}}],status:"pending",payment_preference:"cash",promotion_id:"",event_code:"",booking_id:"",order_notes:""});u.useEffect(()=>{g?.success&&je.success(g.success),g?.error&&je.error(g.error)},[g]),u.useEffect(()=>{const a=setTimeout(me,500);return()=>clearTimeout(a)},[o,O,E,y,H,B]);const me=(a=1)=>{be.get(route("orders.index"),{search:o,status:O==="all"?"":O,country:y==="all"?"":y,payment_preference:E==="all"?"":E,sort_by:H,sort_direction:B,per_page:p.per_page,page:a},{preserveState:!0,replace:!0})},m=a=>{H===a?U(c=>c==="asc"?"desc":"asc"):(q(a),U("asc"))},R=()=>{ie(),de(),w([{id:"",quantity:1,details:{}}]),C("order_notes",""),l([]),C("status","pending"),M(!0)},ue=a=>{const c=a.services.map(N=>({id:N.id,quantity:N.pivot.quantity,details:JSON.parse(N.pivot.details||"{}")}));C({customer_id:a.customer_id,services:c,status:a.status,payment_preference:a.payment_preference,promotion_id:"",event_code:"",booking_id:a.booking_id||"",order_notes:a.notes||""}),w(c),de(),l([]),n(a),X(!0)},he=a=>{n(a),se(!0)},G=a=>{a.preventDefault(),ae(route("orders.store"),{onSuccess:()=>{M(!1),ie()}})},xe=a=>{a.preventDefault(),F(route("orders.update",te.id),{onSuccess:()=>{X(!1),ie()}})},Je=()=>{be.delete(route("orders.destroy",te.id),{onSuccess:()=>se(!1)})},Xe=()=>{D(""),P("all"),S("all"),$("all"),q("created_at"),U("desc")},We=a=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR"}).format(a||0),Ge=a=>{let c="secondary";switch(a){case"pending":c="warning";break;case"paid":c="success";break;case"cancelled":c="destructive";break;default:c="outline"}return e.jsx(Oe,{variant:c,className:"capitalize px-2 py-1 text-xs font-medium",children:a})},Ye=a=>{let c="secondary";switch(a){case"cash":c="purple";break;case"online":c="info";break;default:c="outline"}return e.jsx(Oe,{variant:c,className:"capitalize px-2 py-1 text-xs font-medium",children:a})},Ke=a=>h(c=>c.includes(a)?c.filter(N=>N!==a):[...c,a]),qe=()=>{const a=[...d,{id:"",quantity:1,details:{}}];w(a),C("services",a)},Te=a=>{if(d.length<=1)return;const c=d.filter((N,_)=>_!==a);w(c),C("services",c)},Me=(a,c,N)=>{const _=[...d];_[a]={..._[a],[c]:N},c==="id"&&(_[a].details={}),w(_),C("services",_)},Fe=(a,c,N)=>{const _=[...d];_[a].details={..._[a].details,[c]:N},w(_),C("services",_)};async function Ze({customerId:a,serviceIds:c,eventCode:N}={}){if(!a||!Array.isArray(c)||c.length===0)return l([]),{promotions:[]};x(!0);const _=document.querySelector('meta[name="csrf-token"]')?.content,pe=await fetch(route("promotions.checkEligibility"),{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":_,"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({customer_id:Number(a),service_ids:c.map(Number).filter(Boolean),event_code:N||null})});if(!pe.ok){x(!1);let Le=`HTTP ${pe.status}`;try{const ge=await pe.json();ge?.message&&(Le=ge.message),ge?.errors&&console.error("[checkEligibility] 422 errors:",ge.errors)}catch{}throw new Error(`Failed to check promotions: ${Le}`)}const Ee=await pe.json();return l(Ee?.promotions||[]),x(!1),Ee}u.useEffect(()=>{if(!J)return;const a=b.customer_id,c=(b.services||[]).map(_=>_.id).filter(Boolean),N=b.event_code||"";Ze({customerId:a,serviceIds:c,eventCode:N}).catch(_=>{console.error(_),je.error("Failed to check promotions")})},[J,b.customer_id,JSON.stringify(b.services),b.event_code]);const es=a=>{if(!a)return null;const c=new URL(a),N=new URLSearchParams(c.search);return N.set("search",o),N.set("status",O==="all"?"":O),N.set("payment_preference",E==="all"?"":E),N.set("sort_by",H),N.set("sort_direction",B),`${c.pathname}?${N.toString()}`};return e.jsxs("div",{className:"container mx-auto px-4",children:[e.jsx(Ss,{onAddOrder:R,totals:f}),e.jsx(ce,{className:"mb-8",children:e.jsxs(oe,{children:[e.jsx(ks,{searchTerm:o,setSearchTerm:D,selectedStatus:O,setSelectedStatus:P,selectedPaymentMethod:E,setSelectedPaymentMethod:S,selectedCountry:y,setSelectedCountry:$,clearFilters:Xe,countries:A}),e.jsx(As,{orders:t?.data||[],expandedRows:v,toggleRow:Ke,openEditModal:ue,openDeleteModal:he,getStatusBadge:Ge,getPaymentBadge:Ye,formatPrice:We,formatDate:a=>new Date(a).toLocaleDateString(),sortBy:H,sortDirection:B,handleSort:m}),e.jsx(Os,{paginationData:t,buildPaginationUrl:es})]})}),e.jsx(_e,{open:J,onOpenChange:a=>{M(a),a||(l([]),x(!1))},children:e.jsx(Se,{className:"w-[92vw] sm:w-[88vw] md:w-[720px] lg:w-[900px] xl:w-[1040px] sm:max-w-none overflow-y-auto max-h-[90vh] md:overflow-visible md:max-h-none [scrollbar-gutter:stable] p-0",children:e.jsxs("div",{className:"p-5 sm:p-6",children:[e.jsxs(ke,{children:[e.jsx(Ce,{children:"Create New Order"}),e.jsx(Ae,{children:"Add a new customer order"})]}),e.jsxs("form",{onSubmit:G,children:[e.jsx(Ve,{data:b,setData:C,errors:ne,customers:r,services:i,orderServices:d,updateService:Me,updateServiceDetail:Fe,addService:qe,removeService:Te,eligiblePromos:s,checkingPromo:k}),e.jsx(De,{className:"mt-4 pt-4 border-t bg-background sticky bottom-0 md:static md:bg-transparent md:border-0",children:e.jsx(L,{type:"submit",disabled:re,children:"Create Order"})})]})]})})}),e.jsx(_e,{open:Z,onOpenChange:X,children:e.jsxs(Se,{className:"w-[92vw] sm:w-[540px] md:w-[520px] lg:w-[560px] xl:w-[600px] sm:max-w-none p-4 md:p-5 overflow-visible",children:[e.jsxs(ke,{className:"space-y-1",children:[e.jsx(Ce,{className:"text-base",children:"Edit Order Status"}),e.jsx(Ae,{className:"text-xs",children:"Only status and payment method can be changed."})]}),e.jsxs("form",{onSubmit:xe,className:"mt-2",children:[e.jsx(Ve,{data:b,setData:C,errors:ne,customers:r,services:i,orderServices:d,updateService:Me,updateServiceDetail:Fe,addService:qe,removeService:Te,isPending:W,isStatusUpdateOnly:!0,eligiblePromos:[],checkingPromo:!1}),e.jsx(De,{className:"mt-4",children:e.jsx(L,{type:"submit",size:"sm",disabled:re,children:"Update Order"})})]})]})}),e.jsx(Ds,{isOpen:ee,onOpenChange:se,onConfirm:Je,order:te})]})}Ts.layout=t=>e.jsx(cs,{children:t});export{Ts as default};
