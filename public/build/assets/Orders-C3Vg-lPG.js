import{j as e,b as ie,r as m,c as Ke,u as Ye}from"./app-Tk84mJb6.js";import{c as Ce,B as F}from"./button-lRfnXEjG.js";import{b as Ze,c as es,C as pe,d as ge}from"./card-DQl6oOWn.js";import{S as ss,a as L,b as R,c as U,d as V,e as b,C as ts,A as as,D as le,g as ce,h as oe,i as de,j as me,k as ue}from"./select-Bvp8vyyY.js";import{B as he}from"./badge-mqPbzYBV.js";import{P as ns,T as rs,t as se}from"./index-6VAec2dS.js";import{X as De,d as is,A as ls}from"./AuthenticatedLayout-Baf1-1b3.js";import{D as cs}from"./dollar-sign-C32IAjst.js";import{A as os,P as ds}from"./package-CN-FisGb.js";import{P as Ae}from"./plus-B6nnbVOS.js";import{I as xe,L as Q}from"./index-DnRgCO0U.js";import{F as ne}from"./funnel-8TLH7857.js";import{T as K,a as T,b as Oe,c as Te,d as z,e as Pe}from"./table-BMVx_hAn.js";import{S as ms}from"./scroll-area-D1Kl6wps.js";import{U as us}from"./users-DeZYfit9.js";/* empty css            */import"./index-Dh5pOQR_.js";import"./index-1wYEGG4f.js";/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const hs=[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 18h.01",key:"lrp35t"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M16 18h.01",key:"kzsmim"}]],xs=Ce("calendar-days",hs);/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ps=[["path",{d:"M12 6v6l4 2",key:"mmk7yg"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],gs=Ce("clock",ps),re=s=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(s||0),js=({onAddOrder:s,totals:r={}})=>{r?.total_orders;const l=r?.today_orders??0,u=r?.paid_amount??0,h=r?.pending_amount??0,x=r?.avg_order_value??0,f=[{title:"Paid Amount",value:re(u),icon:cs,color:"text-green-600",bgColor:"bg-green-100",borderColor:"border-green-200"},{title:"Pending Amount",value:re(h),icon:gs,color:"text-amber-600",bgColor:"bg-amber-100",borderColor:"border-amber-200"},{title:"Orders Today",value:l?.toLocaleString?.("id-ID")??l,icon:xs,color:"text-blue-600",bgColor:"bg-blue-100",borderColor:"border-blue-200"},{title:"Avg Order Value",value:re(x),icon:os,color:"text-indigo-600",bgColor:"bg-indigo-100",borderColor:"border-indigo-200"}];return e.jsxs("div",{className:"pb-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx(Ze,{className:"text-2xl font-bold",children:"Orders"}),e.jsx(es,{children:"Manage customer orders"})]}),e.jsxs(F,{onClick:s,className:"flex items-center gap-2",children:[e.jsx(Ae,{className:"h-4 w-4"})," Add Order"]})]}),e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4 pt-6 w-full",children:f.map((c,k)=>e.jsx(pe,{className:`p-2 gap-1 border-b-8 ${c.borderColor}`,children:e.jsx(ge,{className:"p-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-muted-foreground",children:c.title}),e.jsx("div",{className:"text-2xl font-bold",children:c.value})]}),e.jsx("div",{className:`rounded-full p-2 border-2 ${c.bgColor}`,children:e.jsx(c.icon,{className:`h-5 w-5 ${c.color}`})})]})})},k))})]})},fs=({searchTerm:s,setSearchTerm:r,selectedStatus:l,setSelectedStatus:u,selectedPaymentMethod:h,setSelectedPaymentMethod:x,selectedCountry:f,setSelectedCountry:c,clearFilters:k,countries:C})=>e.jsx(pe,{className:" mb-6",children:e.jsx(ge,{children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(ss,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4"}),e.jsx(xe,{placeholder:"Search orders...",value:s,onChange:D=>r(D.target.value),className:"pl-10"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(L,{value:l,onValueChange:u,children:[e.jsxs(R,{className:"w-[180px]",children:[e.jsx(ne,{className:"mr-2 h-4 w-4"}),e.jsx(U,{placeholder:"Status"})]}),e.jsxs(V,{children:[e.jsx(b,{value:"all",children:"All Statuses"}),e.jsx(b,{value:"pending",children:"Pending"}),e.jsx(b,{value:"paid",children:"Paid"}),e.jsx(b,{value:"cancelled",children:"Cancelled"})]})]}),e.jsxs(L,{value:f,onValueChange:c,children:[e.jsxs(R,{className:"w-[180px]",children:[e.jsx(ne,{className:"mr-2 h-4 w-4"}),e.jsx(U,{placeholder:"Country"})]}),e.jsxs(V,{children:[e.jsx(b,{value:"all",children:"All Countries"}),C.map(D=>e.jsx(b,{value:D,children:D},D))]})]}),e.jsxs(L,{value:h,onValueChange:x,children:[e.jsxs(R,{className:"w-[180px]",children:[e.jsx(ne,{className:"mr-2 h-4 w-4"}),e.jsx(U,{placeholder:"Payment"})]}),e.jsxs(V,{children:[e.jsx(b,{value:"all",children:"All Payments"}),e.jsx(b,{value:"cash",children:"Cash"}),e.jsx(b,{value:"online",children:"Online"})]})]}),e.jsxs(F,{variant:"outline",onClick:k,className:"flex items-center gap-2",children:[e.jsx(De,{className:"h-4 w-4"})," Clear Sort & Filters"]})]})]})})}),Ns=({order:s,isExpanded:r,onToggle:l,onEdit:u,onDelete:h,getStatusBadge:x,getPaymentBadge:f,formatPrice:c,formatDate:k})=>{console.log(`--- DEBUG START: Order ID [${s.id}] ---`,{order:s});const C=s.status==="pending",D=n=>{n.stopPropagation(),C?u():se.info("Pesanan ini telah diproses dan tidak dapat diubah.")},I=n=>{n.stopPropagation(),h()},P=(n,g,d=void 0)=>{try{return g.split(".").reduce((t,o)=>t==null?t:t[o],n)??d}catch{return d}},A=(Array.isArray(s.services)?s.services:[]).map(n=>{const g=Number(P(n,"pivot.quantity",0)),d=Number(P(n,"pivot.price_per_unit",0));return{id:Number(n.id),name:n.name,qty:g,base:g*d}}),S=Number(s?.discount_total||0),O=Array.isArray(s?.promotions)&&s.promotions[0]||null;console.log(`[Order ID ${s.id}] DEBUG: Initial Values`,{discountBackend:S,promo:O});let _=null;O&&S>0&&Array.isArray(O.services)&&(O.services.length>0?_=new Set(O.services.map(n=>Number(n.id))):_=new Set(A.map(n=>n.id))),console.log(`[Order ID ${s.id}] DEBUG: Eligible Services Set`,{eligibleSet:_});let $=[];if(S>0&&_){const n=A.filter(d=>_.has(d.id)),g=n.reduce((d,t)=>d+t.base,0);console.log(`[Order ID ${s.id}] DEBUG: Discount Calculation Scope`,{eligibleLines:n,eligibleSubtotal:g}),$=A.map(d=>{let t=0;if(_.has(d.id)&&g>0){const o=d.base/g;t=S*o}return console.log(`[Order ID ${s.id}] DEBUG Line Item (ID: ${d.id})`,{base:d.base,share:g>0?d.base/g:0,calculatedDiscount:t}),{id:d.id,name:d.name,qty:d.qty,lineSubtotal:d.base,lineDiscount:t,lineTotal:d.base-t}})}else console.log(`[Order ID ${s.id}] DEBUG: No Discount Path Taken`,{hasDiscount:S>0,hasEligibleSet:!!_}),$=A.map(n=>({id:n.id,name:n.name,qty:n.qty,lineSubtotal:n.base,lineDiscount:0,lineTotal:n.base}));const H=$.reduce((n,g)=>n+g.lineSubtotal,0),M=$.reduce((n,g)=>n+g.lineDiscount,0),X=H-M;return e.jsxs(e.Fragment,{children:[e.jsxs(K,{className:"cursor-pointer hover:bg-muted/50 transition-colors",onClick:l,children:[e.jsx(T,{className:"w-12",children:e.jsx(F,{variant:"ghost",size:"sm",children:r?e.jsx(ts,{className:"h-4 w-4"}):e.jsx(is,{className:"h-4 w-4"})})}),e.jsx(T,{className:"font-medium",children:s.customer.name}),e.jsx(T,{children:s.customer.passport_country?e.jsx(he,{variant:"outline",children:s.customer.passport_country}):"N/A"}),e.jsx(T,{children:x(s.status)}),e.jsx(T,{children:f(s.payment_preference)}),e.jsx(T,{className:"font-medium",children:c(X)}),e.jsx(T,{children:k(s.updated_at)}),e.jsx(T,{onClick:n=>n.stopPropagation(),children:e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(F,{variant:"ghost",size:"sm",onClick:D,className:C?"bg-secondary text-secondary-foreground":"hidden",children:e.jsx(ns,{className:"h-4 w-4"})}),e.jsx(F,{variant:"ghost",size:"sm",onClick:I,className:"bg-destructive text-destructive-foreground",children:e.jsx(rs,{className:"h-4 w-4"})})]})})]}),r&&e.jsx(K,{children:e.jsx(T,{colSpan:8,className:"p-0",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 p-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-8",children:[e.jsxs("div",{className:"bg-white rounded-lg p-6 shadow-sm md:col-span-2",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"bg-blue-100 p-2 rounded-full",children:e.jsx(us,{className:"h-5 w-5 text-blue-600"})}),e.jsx("h3",{className:"text-lg font-semibold",children:"Customer Information"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-5",children:[e.jsx("span",{className:"font-medium col-span-1",children:"Name"}),e.jsx("span",{className:"col-span-4",children:s.customer.name})]}),e.jsxs("div",{className:"grid grid-cols-5",children:[e.jsx("span",{className:"font-medium col-span-1",children:"Email"}),e.jsx("span",{className:"col-span-4",children:s.customer.email||"N/A"})]}),e.jsxs("div",{className:"grid grid-cols-5",children:[e.jsx("span",{className:"font-medium col-span-1",children:"Phone"}),e.jsx("span",{className:"col-span-4",children:s.customer.phone||"N/A"})]}),e.jsxs("div",{className:"grid grid-cols-5",children:[e.jsx("span",{className:"font-medium col-span-1",children:"Country"}),e.jsx("span",{className:"col-span-4",children:s.customer.passport_country||"N/A"})]})]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-6 shadow-sm md:col-span-3",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"bg-green-100 p-2 rounded-full",children:e.jsx(ds,{className:"h-5 w-5 text-green-600"})}),e.jsx("h3",{className:"text-lg font-semibold",children:"Pricing Details"})]}),$.length>0&&e.jsx("div",{className:"border rounded-lg bg-background overflow-hidden",children:e.jsx(ms,{className:"h-56",children:e.jsxs(Oe,{children:[e.jsx(Te,{children:e.jsxs(K,{children:[e.jsx(z,{className:"w-2/5",children:"Service"}),e.jsx(z,{children:"Qty"}),e.jsx(z,{children:"Subtotal"}),e.jsx(z,{children:"Discount"}),e.jsx(z,{className:"text-right",children:"Total"})]})}),e.jsx(Pe,{children:$.map(n=>e.jsxs(K,{children:[e.jsx(T,{children:n.name}),e.jsx(T,{children:n.qty}),e.jsx(T,{children:c(n.lineSubtotal)}),e.jsx(T,{className:"text-red-600",children:n.lineDiscount>0?`− ${c(n.lineDiscount)}`:"—"}),e.jsx(T,{className:"text-right font-medium",children:c(n.lineTotal)})]},n.id))})]})})}),e.jsxs("div",{className:"space-y-2 mt-4",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Subtotal"}),e.jsx("span",{className:"font-medium",children:c(H)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Discount"}),e.jsx("span",{className:"font-medium text-red-600",children:M>0?`− ${c(M)}`:"—"})]}),e.jsxs("div",{className:"border-t pt-3 mt-2 flex justify-between",children:[e.jsx("span",{className:"text-sm font-semibold",children:"Grand Total"}),e.jsx("span",{className:"font-semibold",children:c(X)})]})]})]})]})})})},`${s.id}-details`)]})},bs=({orders:s,expandedRows:r,toggleRow:l,openEditModal:u,openDeleteModal:h,getStatusBadge:x,getPaymentBadge:f,formatPrice:c,formatDate:k,sortBy:C,sortDirection:D,handleSort:I})=>{const P=({field:y,children:A})=>e.jsx(z,{className:"cursor-pointer",onClick:()=>I(y),children:e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("span",{children:A}),C===y&&e.jsx(as,{className:`h-3 w-3 ${D==="asc"?"rotate-180":""}`})]})});return e.jsx("div",{className:"rounded-md border",children:e.jsxs(Oe,{children:[e.jsx(Te,{children:e.jsxs(K,{children:[e.jsx(z,{className:"w-8"}),e.jsx(P,{field:"customer.name",children:"Customer"}),e.jsx(z,{children:"Country"}),e.jsx(P,{field:"status",children:"Status"}),e.jsx(P,{field:"payment_preference",children:"Payment"}),e.jsx(z,{children:"Total"}),e.jsx(P,{field:"created_at",children:"Date"}),e.jsx(z,{children:"Actions"})]})}),e.jsx(Pe,{children:s.length>0?s.map(y=>e.jsx(Ns,{order:y,isExpanded:r.includes(y.id),onToggle:()=>l(y.id),onEdit:()=>u(y),onDelete:()=>h(y),getStatusBadge:x,getPaymentBadge:f,formatPrice:c,formatDate:k},y.id)):e.jsx(K,{children:e.jsx(T,{colSpan:8,className:"text-center py-8",children:"No orders found"})})})]})})},ys=({isOpen:s,onOpenChange:r,onConfirm:l,order:u})=>u?e.jsx(le,{open:s,onOpenChange:r,children:e.jsxs(ce,{children:[e.jsxs(oe,{children:[e.jsx(de,{children:"Confirm Deletion"}),e.jsxs(me,{children:["Are you sure you want to delete the order for"," ",e.jsx("strong",{children:u.customer.name}),"? This action cannot be undone."]})]}),e.jsxs(ue,{children:[e.jsx(F,{variant:"outline",onClick:()=>r(!1),children:"Cancel"}),e.jsx(F,{variant:"destructive",onClick:l,children:"Delete"})]})]})}):null,vs=({paginationData:s,buildPaginationUrl:r})=>{const{from:l,to:u,total:h,prev_page_url:x,next_page_url:f}=s,c=k=>{k&&ie.get(r(k),{},{preserveState:!0,replace:!0})};return e.jsxs("div",{className:"flex items-center justify-between mt-6",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Showing ",l," to ",u," of ",h," results"]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(F,{variant:"outline",size:"sm",onClick:()=>c(x),disabled:!x,children:"Previous"}),e.jsx(F,{variant:"outline",size:"sm",onClick:()=>c(f),disabled:!f,children:"Next"})]})]})},$e=s=>!s&&s!==0?"N/A":new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR"}).format(s);function Ss(s){const r=s?.options;if(!r)return[];if(Array.isArray(r))return r;try{const l=JSON.parse(r);return Array.isArray(l)?l:[]}catch{return[]}}function _s(s,r){const l=[];if(s.discount_percent&&l.push(`${s.discount_percent}% off`),s.discount_amount&&l.push(`${$e(Number(s.discount_amount))} off`),s.free_service_id){const h=r?.[s.free_service_id]?.name||`Service #${s.free_service_id}`,x=s.free_service_qty||1;l.push(`Free: ${h} × ${x}`)}const u=l.length?l.join(" • "):"Special offer";return`${s.name} (${s.type}) — ${u}`}function ws(s){if(!s)return null;const r=String(s).toLowerCase();return["reserved"].includes(r)?new Set(["pre_checkin"]):["checked_in"].includes(r)?new Set(["post_checkin","pre_checkout"]):null}const ke=({data:s,setData:r,errors:l,customers:u,services:h,orderServices:x,updateService:f,updateServiceDetail:c,addService:k,removeService:C,isPending:D=!0,isStatusUpdateOnly:I=!1,eligiblePromos:P=[],checkingPromo:y=!1})=>{const A=!I,S=(h||[]).reduce((t,o)=>(t[o.id]=o,t),{}),[O,_]=m.useState([]),[$,H]=m.useState(!1),[M,X]=m.useState(""),n=m.useMemo(()=>{if(!s.booking_id)return null;const t=Number(s.booking_id);return O.find(o=>Number(o.id)===t)||null},[s.booking_id,O]),g=m.useMemo(()=>ws(n?.status),[n]),d=m.useMemo(()=>!Array.isArray(h)||h.length===0?[]:g?h.filter(t=>g.has(t.offering_session)):h,[h,g]);return m.useEffect(()=>{if(!A||!Array.isArray(x)||x.length===0)return;const t=new Set(d.map(N=>String(N.id)));let o=!1;const E=x.map(N=>!N?.id||t.has(String(N.id))?N:(o=!0,{id:"",quantity:1,details:{}}));o&&E.forEach((N,w)=>{String(x[w]?.id||"")!==String(N.id||"")&&f(w,"id",N.id),(x[w]?.quantity??1)!==(N.quantity??1)&&f(w,"quantity",N.quantity),f(w,"details",N.details)})},[d,x,A,f]),m.useEffect(()=>{if(!A)return;const t=s.customer_id;if(s.booking_id&&r("booking_id",""),!t){_([]),X("");return}let o=!1;return(async()=>{try{H(!0),X("");const E=await fetch(`/api/customers/${t}/bookings?onlyActive=1`,{credentials:"same-origin",headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"}});if(!E.ok)throw new Error(`HTTP ${E.status}`);const N=await E.json();if(o)return;_(Array.isArray(N.bookings)?N.bookings:[])}catch{o||(X("Failed to load bookings for this customer."),_([]))}finally{o||H(!1)}})(),()=>{o=!0}},[A,s.customer_id]),e.jsxs("div",{className:"grid gap-4 py-4",children:[A&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Q,{htmlFor:"customer_id",className:"text-right",children:"Customer *"}),e.jsxs(L,{value:s.customer_id,onValueChange:t=>r("customer_id",t),children:[e.jsx(R,{className:"col-span-3",children:e.jsx(U,{placeholder:"Select customer"})}),e.jsx(V,{children:u.map(t=>e.jsx(b,{value:t.id.toString(),children:t.name},t.id))})]}),l.customer_id&&e.jsx("p",{className:"text-red-500 text-sm col-span-4 text-right",children:l.customer_id})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Q,{htmlFor:"booking_id",className:"text-right",children:"Booking"}),e.jsxs("div",{className:"col-span-3 space-y-1",children:[e.jsxs(L,{value:s.booking_id||"",onValueChange:t=>r("booking_id",t),disabled:!s.customer_id||$||O.length===0,children:[e.jsx(R,{children:e.jsx(U,{placeholder:s.customer_id?$?"Loading bookings…":O.length?"Select booking (optional)":"No active bookings":"Select customer first"})}),e.jsx(V,{children:O.map(t=>{const o=t.room_label?`${t.room_label} • ${t.status} • ${new Date(t.checkin_at).toLocaleDateString()} - ${new Date(t.checkout_at).toLocaleDateString()}`:`Booking #${t.id} • ${t.status}`;return e.jsx(b,{value:String(t.id),children:o},t.id)})})]}),M&&e.jsx("p",{className:"text-xs text-red-500",children:M}),!M&&s.customer_id&&O.length===0&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"This customer has no active bookings. You may leave it blank."}),!s.customer_id&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"Pick a customer to choose a booking."})]})]}),e.jsx("fieldset",{disabled:!D,children:e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"grid grid-cols-4 items-start gap-4",children:[e.jsx(Q,{className:"text-right pt-2",children:"Services *"}),e.jsxs("div",{className:"col-span-3 space-y-2",children:[x.map((t,o)=>{const E=d.find(j=>String(j.id)===String(t.id)),N=Ss(E||S[t.id]),w=E?.type||S[t.id]?.type,G=w==="selectable",Y=w==="per_unit",q=E?.unit_name||S[t.id]?.unit_name||"",te=G&&!t?.details?.package,W=Y&&(t?.details?.weight===void 0||t?.details?.weight===null||t?.details?.weight===""||Number.isNaN(Number(t?.details?.weight)));return e.jsxs("div",{className:"border rounded p-3 space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h4",{className:"font-medium",children:["Service #",o+1]}),x.length>1&&e.jsx(F,{type:"button",variant:"outline",size:"sm",onClick:()=>C(o),children:e.jsx(De,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"grid grid-cols-12 gap-2",children:[e.jsx("div",{className:"col-span-7",children:e.jsxs(L,{value:t.id,onValueChange:j=>f(o,"id",j),children:[e.jsx(R,{children:e.jsx(U,{placeholder:"Select service"})}),e.jsx(V,{children:d.map(j=>e.jsxs(b,{value:j.id.toString(),children:[j.name," "]},j.id))})]})}),e.jsx("div",{className:"col-span-5",children:e.jsx(xe,{type:"number",min:"1",placeholder:"Quantity",value:t.quantity,onChange:j=>f(o,"quantity",parseInt(j.target.value)||1)})})]}),E&&e.jsxs(e.Fragment,{children:[G&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs(L,{value:t?.details?.package||"",onValueChange:j=>c(o,"package",j),children:[e.jsx(R,{children:e.jsx(U,{placeholder:"Select option"})}),e.jsx(V,{children:N.map((j,B)=>e.jsxs(b,{value:j.name,children:[j.name," — ",$e(Number(j.price))]},B))})]}),te?e.jsx("p",{className:"text-xs text-red-500",children:"Option is required for this service."}):e.jsx("p",{className:"text-xs text-muted-foreground",children:"Choose package/variant."})]}),Y&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(xe,{type:"number",min:"0",step:"0.01",placeholder:q?`Amount (${q})`:"Amount",value:t?.details?.weight??"",onChange:j=>c(o,"weight",j.target.value===""?"":parseFloat(j.target.value)||0)}),q&&e.jsx("span",{className:"text-sm text-muted-foreground",children:q})]}),W?e.jsx("p",{className:"text-xs text-red-500",children:q?`${q} is required.`:"Amount is required."}):e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Enter the ",q||"amount"," for this service."]})]})]})]},o)}),e.jsxs(F,{type:"button",variant:"outline",size:"sm",onClick:k,className:"mt-2",children:[e.jsx(Ae,{className:"h-4 w-4 mr-1"})," Add Service"]}),l.services&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:l.services})]})]})})}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Q,{className:"text-right",children:"Promotion"}),e.jsxs("div",{className:"col-span-3 space-y-2",children:[e.jsxs(L,{value:s.promotion_id||"",onValueChange:t=>r("promotion_id",t),disabled:y||P.length===0,children:[e.jsx(R,{children:e.jsx(U,{placeholder:y?"Checking promotions…":P.length?"Select a promotion":"No promotion available"})}),e.jsx(V,{children:P.map(t=>e.jsx(b,{value:String(t.id),children:_s(t,S)},t.id))})]}),l.promotion_id&&e.jsx("p",{className:"text-red-500 text-sm",children:l.promotion_id})]})]})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Q,{htmlFor:"status",className:"text-right",children:"Status *"}),e.jsxs(L,{value:s.status,onValueChange:t=>r("status",t),children:[e.jsx(R,{className:"col-span-3",children:e.jsx(U,{placeholder:"Select status"})}),e.jsxs(V,{children:[e.jsx(b,{value:"pending",children:"Pending"}),e.jsx(b,{value:"paid",children:"Paid"}),e.jsx(b,{value:"cancelled",children:"Cancelled"})]})]}),l.status&&e.jsx("p",{className:"text-red-500 text-sm col-span-4 text-right",children:l.status})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(Q,{htmlFor:"payment_preference",className:"text-right",children:"Payment Method *"}),e.jsxs(L,{value:s.payment_preference,onValueChange:t=>r("payment_preference",t),disabled:!D,children:[e.jsx(R,{className:"col-span-3",children:e.jsx(U,{placeholder:"Select payment method"})}),e.jsxs(V,{children:[e.jsx(b,{value:"cash",children:"Cash"}),e.jsx(b,{value:"online",children:"Online"})]})]}),l.payment_preference&&e.jsx("p",{className:"text-red-500 text-sm col-span-4 text-right",children:l.payment_preference})]})]})};function ks(){const{orders:s,customers:r,services:l,filters:u,flash:h,totals:x}=Ke().props,f=[...new Set(r.map(a=>a.passport_country).filter(Boolean))],[c,k]=m.useState(u.search||""),[C,D]=m.useState(u.status||"all"),[I,P]=m.useState(u.payment_preference||"all"),[y,A]=m.useState(u.country||"all"),[S,O]=m.useState(u.sort_by||"created_at"),[_,$]=m.useState(u.sort_direction||"desc"),[H,M]=m.useState(!1),[X,n]=m.useState(!1),[g,d]=m.useState(!1),[t,o]=m.useState(null),[E,N]=m.useState([]),[w,G]=m.useState([{id:"",quantity:1,details:{}}]),[Y,q]=m.useState([]),[te,W]=m.useState(!1),j=t?.status==="pending",{data:B,setData:J,post:Ee,put:qe,processing:je,errors:fe,reset:ae,clearErrors:Ne}=Ye({customer_id:"",services:[{id:"",quantity:1,details:{}}],status:"pending",payment_preference:"cash",promotion_id:"",event_code:"",booking_id:""});m.useEffect(()=>{h?.success&&se.success(h.success),h?.error&&se.error(h.error)},[h]),m.useEffect(()=>{const a=setTimeout(Fe,500);return()=>clearTimeout(a)},[c,C,I,y,S,_]);const Fe=(a=1)=>{ie.get(route("orders.index"),{search:c,status:C==="all"?"":C,country:y==="all"?"":y,payment_preference:I==="all"?"":I,sort_by:S,sort_direction:_,per_page:u.per_page,page:a},{preserveState:!0,replace:!0})},Ie=a=>{S===a?$(i=>i==="asc"?"desc":"asc"):(O(a),$("asc"))},Me=()=>{ae(),Ne(),G([{id:"",quantity:1,details:{}}]),q([]),J("status","pending"),M(!0)},Be=a=>{const i=a.services.map(p=>({id:p.id,quantity:p.pivot.quantity,details:JSON.parse(p.pivot.details||"{}")}));J({customer_id:a.customer_id,services:i,status:a.status,payment_preference:a.payment_preference,promotion_id:"",event_code:"",booking_id:a.booking_id||""}),G(i),Ne(),q([]),o(a),n(!0)},Le=a=>{o(a),d(!0)},Re=a=>{a.preventDefault(),Ee(route("orders.store"),{onSuccess:()=>{M(!1),ae()}})},Ue=a=>{a.preventDefault(),qe(route("orders.update",t.id),{onSuccess:()=>{n(!1),ae()}})},Ve=()=>{ie.delete(route("orders.destroy",t.id),{onSuccess:()=>d(!1)})},ze=()=>{k(""),D("all"),P("all"),A("all"),O("created_at"),$("desc")},He=a=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR"}).format(a||0),Ge=a=>{let i="secondary";switch(a){case"pending":i="warning";break;case"paid":i="success";break;case"cancelled":i="destructive";break;default:i="outline"}return e.jsx(he,{variant:i,className:"capitalize px-2 py-1 text-xs font-medium",children:a})},Xe=a=>{let i="secondary";switch(a){case"cash":i="purple";break;case"online":i="info";break;default:i="outline"}return e.jsx(he,{variant:i,className:"capitalize px-2 py-1 text-xs font-medium",children:a})},Je=a=>N(i=>i.includes(a)?i.filter(p=>p!==a):[...i,a]),be=()=>{const a=[...w,{id:"",quantity:1,details:{}}];G(a),J("services",a)},ye=a=>{if(w.length<=1)return;const i=w.filter((p,v)=>v!==a);G(i),J("services",i)},ve=(a,i,p)=>{const v=[...w];v[a]={...v[a],[i]:p},i==="id"&&(v[a].details={}),G(v),J("services",v)},Se=(a,i,p)=>{const v=[...w];v[a].details={...v[a].details,[i]:p},G(v),J("services",v)};async function We({customerId:a,serviceIds:i,eventCode:p}={}){if(!a||!Array.isArray(i)||i.length===0)return q([]),{promotions:[]};W(!0);const v=document.querySelector('meta[name="csrf-token"]')?.content,Z=await fetch(route("promotions.checkEligibility"),{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":v,"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({customer_id:Number(a),service_ids:i.map(Number).filter(Boolean),event_code:p||null})});if(!Z.ok){W(!1);let we=`HTTP ${Z.status}`;try{const ee=await Z.json();ee?.message&&(we=ee.message),ee?.errors&&console.error("[checkEligibility] 422 errors:",ee.errors)}catch{}throw new Error(`Failed to check promotions: ${we}`)}const _e=await Z.json();return q(_e?.promotions||[]),W(!1),_e}m.useEffect(()=>{if(!H)return;const a=B.customer_id,i=(B.services||[]).map(v=>v.id).filter(Boolean),p=B.event_code||"";We({customerId:a,serviceIds:i,eventCode:p}).catch(v=>{console.error(v),se.error("Failed to check promotions")})},[H,B.customer_id,JSON.stringify(B.services),B.event_code]);const Qe=a=>{if(!a)return null;const i=new URL(a),p=new URLSearchParams(i.search);return p.set("search",c),p.set("status",C==="all"?"":C),p.set("payment_preference",I==="all"?"":I),p.set("sort_by",S),p.set("sort_direction",_),`${i.pathname}?${p.toString()}`};return e.jsxs("div",{className:"container mx-auto px-4",children:[e.jsx(js,{onAddOrder:Me,totals:x}),e.jsx(pe,{className:"mb-8",children:e.jsxs(ge,{children:[e.jsx(fs,{searchTerm:c,setSearchTerm:k,selectedStatus:C,setSelectedStatus:D,selectedPaymentMethod:I,setSelectedPaymentMethod:P,selectedCountry:y,setSelectedCountry:A,clearFilters:ze,countries:f}),e.jsx(bs,{orders:s?.data||[],expandedRows:E,toggleRow:Je,openEditModal:Be,openDeleteModal:Le,getStatusBadge:Ge,getPaymentBadge:Xe,formatPrice:He,formatDate:a=>new Date(a).toLocaleDateString(),sortBy:S,sortDirection:_,handleSort:Ie}),e.jsx(vs,{paginationData:s,buildPaginationUrl:Qe})]})}),e.jsx(le,{open:H,onOpenChange:a=>{M(a),a||(q([]),W(!1))},children:e.jsxs(ce,{className:"sm:max-w-[760px]",children:[e.jsxs(oe,{children:[e.jsx(de,{children:"Create New Order"}),e.jsx(me,{children:"Add a new customer order"})]}),e.jsxs("form",{onSubmit:Re,children:[e.jsx(ke,{data:B,setData:J,errors:fe,customers:r,services:l,orderServices:w,updateService:ve,updateServiceDetail:Se,addService:be,removeService:ye,eligiblePromos:Y,checkingPromo:te}),e.jsx(ue,{children:e.jsx(F,{type:"submit",disabled:je,children:"Create Order"})})]})]})}),e.jsx(le,{open:X,onOpenChange:n,children:e.jsxs(ce,{className:"sm:max-w-[700px]",children:[e.jsxs(oe,{children:[e.jsx(de,{children:"Edit Order Status"}),e.jsx(me,{children:"Only status and payment method can be changed."})]}),e.jsxs("form",{onSubmit:Ue,children:[e.jsx(ke,{data:B,setData:J,errors:fe,customers:r,services:l,orderServices:w,updateService:ve,updateServiceDetail:Se,addService:be,removeService:ye,isPending:j,isStatusUpdateOnly:!0,eligiblePromos:[],checkingPromo:!1}),e.jsx(ue,{children:e.jsx(F,{type:"submit",disabled:je,children:"Update Order"})})]})]})}),e.jsx(ys,{isOpen:g,onOpenChange:d,onConfirm:Ve,order:t})]})}ks.layout=s=>e.jsx(ls,{children:s});export{ks as default};
