import{j as e,b as ne,r as h,c as Ke,u as Ye}from"./app-CyNV4xla.js";import{c as we,B as P}from"./button-CxkxaUXA.js";import{b as Ze,c as es,C as he,d as xe}from"./card-C7DOrj8d.js";import{S as ss,a as E,b as I,c as F,d as B,e as j,C as ts,A as as,D as re,g as ie,h as le,i as ce,j as oe,k as de}from"./select-D1oHE82z.js";import{B as me}from"./badge-CLtzMiH2.js";import{P as ns,T as rs,t as ee}from"./index-lk-SwVZz.js";import{X as Ce,d as is,A as ls}from"./AuthenticatedLayout-_OcRwaJT.js";import{D as cs}from"./dollar-sign-CIAkuSGu.js";import{A as os,P as ds}from"./package-BNrsyiRT.js";import{P as ke}from"./plus-CY3rKiNZ.js";import{I as ue,L as J}from"./index-BzOwoEwx.js";import{F as te}from"./funnel-C6VIQAg6.js";import{T as W,a as w,b as De,c as Oe,d as M,e as Ae}from"./table-COKPj6eX.js";import{S as ms}from"./scroll-area-BKDP1Es3.js";import{U as us}from"./users-HS9CwaX6.js";/* empty css            */import"./index-CDm6i81c.js";import"./index-DnOCixzh.js";/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const hs=[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 18h.01",key:"lrp35t"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M16 18h.01",key:"kzsmim"}]],xs=we("calendar-days",hs);/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ps=[["path",{d:"M12 6v6l4 2",key:"mmk7yg"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],js=we("clock",ps),ae=t=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(t||0),gs=({onAddOrder:t,totals:r={}})=>{r?.total_orders;const i=r?.today_orders??0,d=r?.paid_amount??0,m=r?.pending_amount??0,v=r?.avg_order_value??0,b=[{title:"Paid Amount",value:ae(d),icon:cs,color:"text-green-600",bgColor:"bg-green-100",borderColor:"border-green-200"},{title:"Pending Amount",value:ae(m),icon:js,color:"text-amber-600",bgColor:"bg-amber-100",borderColor:"border-amber-200"},{title:"Orders Today",value:i?.toLocaleString?.("id-ID")??i,icon:xs,color:"text-blue-600",bgColor:"bg-blue-100",borderColor:"border-blue-200"},{title:"Avg Order Value",value:ae(v),icon:os,color:"text-indigo-600",bgColor:"bg-indigo-100",borderColor:"border-indigo-200"}];return e.jsxs("div",{className:"pb-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx(Ze,{className:"text-2xl font-bold",children:"Orders"}),e.jsx(es,{children:"Manage customer orders"})]}),e.jsxs(P,{onClick:t,className:"flex items-center gap-2",children:[e.jsx(ke,{className:"h-4 w-4"})," Add Order"]})]}),e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4 pt-6 w-full",children:b.map((o,y)=>e.jsx(he,{className:`p-2 gap-1 border-b-8 ${o.borderColor}`,children:e.jsx(xe,{className:"p-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-muted-foreground",children:o.title}),e.jsx("div",{className:"text-2xl font-bold",children:o.value})]}),e.jsx("div",{className:`rounded-full p-2 border-2 ${o.bgColor}`,children:e.jsx(o.icon,{className:`h-5 w-5 ${o.color}`})})]})})},y))})]})},fs=({searchTerm:t,setSearchTerm:r,selectedStatus:i,setSelectedStatus:d,selectedPaymentMethod:m,setSelectedPaymentMethod:v,selectedCountry:b,setSelectedCountry:o,clearFilters:y,countries:S})=>e.jsx(he,{className:" mb-6",children:e.jsx(xe,{children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(ss,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4"}),e.jsx(ue,{placeholder:"Search orders...",value:t,onChange:_=>r(_.target.value),className:"pl-10"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(E,{value:i,onValueChange:d,children:[e.jsxs(I,{className:"w-[180px]",children:[e.jsx(te,{className:"mr-2 h-4 w-4"}),e.jsx(F,{placeholder:"Status"})]}),e.jsxs(B,{children:[e.jsx(j,{value:"all",children:"All Statuses"}),e.jsx(j,{value:"pending",children:"Pending"}),e.jsx(j,{value:"paid",children:"Paid"}),e.jsx(j,{value:"cancelled",children:"Cancelled"})]})]}),e.jsxs(E,{value:b,onValueChange:o,children:[e.jsxs(I,{className:"w-[180px]",children:[e.jsx(te,{className:"mr-2 h-4 w-4"}),e.jsx(F,{placeholder:"Country"})]}),e.jsxs(B,{children:[e.jsx(j,{value:"all",children:"All Countries"}),S.map(_=>e.jsx(j,{value:_,children:_},_))]})]}),e.jsxs(E,{value:m,onValueChange:v,children:[e.jsxs(I,{className:"w-[180px]",children:[e.jsx(te,{className:"mr-2 h-4 w-4"}),e.jsx(F,{placeholder:"Payment"})]}),e.jsxs(B,{children:[e.jsx(j,{value:"all",children:"All Payments"}),e.jsx(j,{value:"cash",children:"Cash"}),e.jsx(j,{value:"online",children:"Online"})]})]}),e.jsxs(P,{variant:"outline",onClick:y,className:"flex items-center gap-2",children:[e.jsx(Ce,{className:"h-4 w-4"})," Clear Sort & Filters"]})]})]})})}),vs=({order:t,isExpanded:r,onToggle:i,onEdit:d,onDelete:m,getStatusBadge:v,getPaymentBadge:b,formatPrice:o,formatDate:y})=>{console.log(`--- DEBUG START: Order ID [${t.id}] ---`,{order:t});const S=t.status==="pending",_=s=>{s.stopPropagation(),S?d():ee.info("Pesanan ini telah diproses dan tidak dapat diubah.")},T=s=>{s.stopPropagation(),m()},C=(s,l,c=void 0)=>{try{return l.split(".").reduce((x,R)=>x==null?x:x[R],s)??c}catch{return c}},k=(Array.isArray(t.services)?t.services:[]).map(s=>{const l=Number(C(s,"pivot.quantity",0)),c=Number(C(s,"pivot.price_per_unit",0));return{id:Number(s.id),name:s.name,qty:l,base:l*c}}),D=Number(t?.discount_total||0),O=Array.isArray(t?.promotions)&&t.promotions[0]||null;console.log(`[Order ID ${t.id}] DEBUG: Initial Values`,{discountBackend:D,promo:O});let N=null;O&&D>0&&Array.isArray(O.services)&&(O.services.length>0?N=new Set(O.services.map(s=>Number(s.id))):N=new Set(k.map(s=>s.id))),console.log(`[Order ID ${t.id}] DEBUG: Eligible Services Set`,{eligibleSet:N});let A=[];if(D>0&&N){const s=k.filter(c=>N.has(c.id)),l=s.reduce((c,x)=>c+x.base,0);console.log(`[Order ID ${t.id}] DEBUG: Discount Calculation Scope`,{eligibleLines:s,eligibleSubtotal:l}),A=k.map(c=>{let x=0;if(N.has(c.id)&&l>0){const R=c.base/l;x=D*R}return console.log(`[Order ID ${t.id}] DEBUG Line Item (ID: ${c.id})`,{base:c.base,share:l>0?c.base/l:0,calculatedDiscount:x}),{id:c.id,name:c.name,qty:c.qty,lineSubtotal:c.base,lineDiscount:x,lineTotal:c.base-x}})}else console.log(`[Order ID ${t.id}] DEBUG: No Discount Path Taken`,{hasDiscount:D>0,hasEligibleSet:!!N}),A=k.map(s=>({id:s.id,name:s.name,qty:s.qty,lineSubtotal:s.base,lineDiscount:0,lineTotal:s.base}));const q=A.reduce((s,l)=>s+l.lineSubtotal,0),$=A.reduce((s,l)=>s+l.lineDiscount,0),V=q-$;return e.jsxs(e.Fragment,{children:[e.jsxs(W,{className:"cursor-pointer hover:bg-muted/50 transition-colors",onClick:i,children:[e.jsx(w,{className:"w-12",children:e.jsx(P,{variant:"ghost",size:"sm",children:r?e.jsx(ts,{className:"h-4 w-4"}):e.jsx(is,{className:"h-4 w-4"})})}),e.jsx(w,{className:"font-medium",children:t.customer.name}),e.jsx(w,{children:t.customer.passport_country?e.jsx(me,{variant:"outline",children:t.customer.passport_country}):"N/A"}),e.jsx(w,{children:v(t.status)}),e.jsx(w,{children:b(t.payment_preference)}),e.jsx(w,{className:"font-medium",children:o(V)}),e.jsx(w,{children:y(t.updated_at)}),e.jsx(w,{onClick:s=>s.stopPropagation(),children:e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(P,{variant:"ghost",size:"sm",onClick:_,className:S?"bg-secondary text-secondary-foreground":"hidden",children:e.jsx(ns,{className:"h-4 w-4"})}),e.jsx(P,{variant:"ghost",size:"sm",onClick:T,className:"bg-destructive text-destructive-foreground",children:e.jsx(rs,{className:"h-4 w-4"})})]})})]}),r&&e.jsx(W,{children:e.jsx(w,{colSpan:8,className:"p-0",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 p-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-8",children:[e.jsxs("div",{className:"bg-white rounded-lg p-6 shadow-sm md:col-span-2",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"bg-blue-100 p-2 rounded-full",children:e.jsx(us,{className:"h-5 w-5 text-blue-600"})}),e.jsx("h3",{className:"text-lg font-semibold",children:"Customer Information"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-5",children:[e.jsx("span",{className:"font-medium col-span-1",children:"Name"}),e.jsx("span",{className:"col-span-4",children:t.customer.name})]}),e.jsxs("div",{className:"grid grid-cols-5",children:[e.jsx("span",{className:"font-medium col-span-1",children:"Email"}),e.jsx("span",{className:"col-span-4",children:t.customer.email||"N/A"})]}),e.jsxs("div",{className:"grid grid-cols-5",children:[e.jsx("span",{className:"font-medium col-span-1",children:"Phone"}),e.jsx("span",{className:"col-span-4",children:t.customer.phone||"N/A"})]}),e.jsxs("div",{className:"grid grid-cols-5",children:[e.jsx("span",{className:"font-medium col-span-1",children:"Country"}),e.jsx("span",{className:"col-span-4",children:t.customer.passport_country||"N/A"})]})]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-6 shadow-sm md:col-span-3",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"bg-green-100 p-2 rounded-full",children:e.jsx(ds,{className:"h-5 w-5 text-green-600"})}),e.jsx("h3",{className:"text-lg font-semibold",children:"Pricing Details"})]}),A.length>0&&e.jsx("div",{className:"border rounded-lg bg-background overflow-hidden",children:e.jsx(ms,{className:"h-56",children:e.jsxs(De,{children:[e.jsx(Oe,{children:e.jsxs(W,{children:[e.jsx(M,{className:"w-2/5",children:"Service"}),e.jsx(M,{children:"Qty"}),e.jsx(M,{children:"Subtotal"}),e.jsx(M,{children:"Discount"}),e.jsx(M,{className:"text-right",children:"Total"})]})}),e.jsx(Ae,{children:A.map(s=>e.jsxs(W,{children:[e.jsx(w,{children:s.name}),e.jsx(w,{children:s.qty}),e.jsx(w,{children:o(s.lineSubtotal)}),e.jsx(w,{className:"text-red-600",children:s.lineDiscount>0?`− ${o(s.lineDiscount)}`:"—"}),e.jsx(w,{className:"text-right font-medium",children:o(s.lineTotal)})]},s.id))})]})})}),e.jsxs("div",{className:"space-y-2 mt-4",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Subtotal"}),e.jsx("span",{className:"font-medium",children:o(q)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Discount"}),e.jsx("span",{className:"font-medium text-red-600",children:$>0?`− ${o($)}`:"—"})]}),e.jsxs("div",{className:"border-t pt-3 mt-2 flex justify-between",children:[e.jsx("span",{className:"text-sm font-semibold",children:"Grand Total"}),e.jsx("span",{className:"font-semibold",children:o(V)})]})]})]})]})})})},`${t.id}-details`)]})},Ns=({orders:t,expandedRows:r,toggleRow:i,openEditModal:d,openDeleteModal:m,getStatusBadge:v,getPaymentBadge:b,formatPrice:o,formatDate:y,sortBy:S,sortDirection:_,handleSort:T})=>{const C=({field:g,children:k})=>e.jsx(M,{className:"cursor-pointer",onClick:()=>T(g),children:e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("span",{children:k}),S===g&&e.jsx(as,{className:`h-3 w-3 ${_==="asc"?"rotate-180":""}`})]})});return e.jsx("div",{className:"rounded-md border",children:e.jsxs(De,{children:[e.jsx(Oe,{children:e.jsxs(W,{children:[e.jsx(M,{className:"w-8"}),e.jsx(C,{field:"customer.name",children:"Customer"}),e.jsx(M,{children:"Country"}),e.jsx(C,{field:"status",children:"Status"}),e.jsx(C,{field:"payment_preference",children:"Payment"}),e.jsx(M,{children:"Total"}),e.jsx(C,{field:"created_at",children:"Date"}),e.jsx(M,{children:"Actions"})]})}),e.jsx(Ae,{children:t.length>0?t.map(g=>e.jsx(vs,{order:g,isExpanded:r.includes(g.id),onToggle:()=>i(g.id),onEdit:()=>d(g),onDelete:()=>m(g),getStatusBadge:v,getPaymentBadge:b,formatPrice:o,formatDate:y},g.id)):e.jsx(W,{children:e.jsx(w,{colSpan:8,className:"text-center py-8",children:"No orders found"})})})]})})},bs=({isOpen:t,onOpenChange:r,onConfirm:i,order:d})=>d?e.jsx(re,{open:t,onOpenChange:r,children:e.jsxs(ie,{children:[e.jsxs(le,{children:[e.jsx(ce,{children:"Confirm Deletion"}),e.jsxs(oe,{children:["Are you sure you want to delete the order for"," ",e.jsx("strong",{children:d.customer.name}),"? This action cannot be undone."]})]}),e.jsxs(de,{children:[e.jsx(P,{variant:"outline",onClick:()=>r(!1),children:"Cancel"}),e.jsx(P,{variant:"destructive",onClick:i,children:"Delete"})]})]})}):null,ys=({paginationData:t,buildPaginationUrl:r})=>{const{from:i,to:d,total:m,prev_page_url:v,next_page_url:b}=t,o=y=>{y&&ne.get(r(y),{},{preserveState:!0,replace:!0})};return e.jsxs("div",{className:"flex items-center justify-between mt-6",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Showing ",i," to ",d," of ",m," results"]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(P,{variant:"outline",size:"sm",onClick:()=>o(v),disabled:!v,children:"Previous"}),e.jsx(P,{variant:"outline",size:"sm",onClick:()=>o(b),disabled:!b,children:"Next"})]})]})},Pe=t=>!t&&t!==0?"N/A":new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR"}).format(t);function Ss(t){const r=t?.options;if(!r)return[];if(Array.isArray(r))return r;try{const i=JSON.parse(r);return Array.isArray(i)?i:[]}catch{return[]}}function _s(t,r){const i=[];if(t.discount_percent&&i.push(`${t.discount_percent}% off`),t.discount_amount&&i.push(`${Pe(Number(t.discount_amount))} off`),t.free_service_id){const m=r?.[t.free_service_id]?.name||`Service #${t.free_service_id}`,v=t.free_service_qty||1;i.push(`Free: ${m} × ${v}`)}const d=i.length?i.join(" • "):"Special offer";return`${t.name} (${t.type}) — ${d}`}const _e=({data:t,setData:r,errors:i,customers:d,services:m,orderServices:v,updateService:b,updateServiceDetail:o,addService:y,removeService:S,isPending:_=!0,isStatusUpdateOnly:T=!1,eligiblePromos:C=[],checkingPromo:g=!1})=>{const k=!T,D=(m||[]).reduce((s,l)=>(s[l.id]=l,s),{}),[O,N]=h.useState([]),[A,q]=h.useState(!1),[$,V]=h.useState("");return h.useEffect(()=>{if(!k)return;const s=t.customer_id;if(t.booking_id&&r("booking_id",""),!s){N([]),V("");return}let l=!1;return(async()=>{try{q(!0),V("");const c=await fetch(`/api/customers/${s}/bookings?onlyActive=1`,{credentials:"same-origin",headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"}});if(!c.ok)throw new Error(`HTTP ${c.status}`);const x=await c.json();if(l)return;N(Array.isArray(x.bookings)?x.bookings:[])}catch{l||(V("Failed to load bookings for this customer."),N([]))}finally{l||q(!1)}})(),()=>{l=!0}},[k,t.customer_id]),e.jsxs("div",{className:"grid gap-4 py-4",children:[k&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(J,{htmlFor:"customer_id",className:"text-right",children:"Customer *"}),e.jsxs(E,{value:t.customer_id,onValueChange:s=>r("customer_id",s),children:[e.jsx(I,{className:"col-span-3",children:e.jsx(F,{placeholder:"Select customer"})}),e.jsx(B,{children:d.map(s=>e.jsx(j,{value:s.id.toString(),children:s.name},s.id))})]}),i.customer_id&&e.jsx("p",{className:"text-red-500 text-sm col-span-4 text-right",children:i.customer_id})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(J,{htmlFor:"booking_id",className:"text-right",children:"Booking"}),e.jsxs("div",{className:"col-span-3 space-y-1",children:[e.jsxs(E,{value:t.booking_id||"",onValueChange:s=>r("booking_id",s),disabled:!t.customer_id||A||O.length===0,children:[e.jsx(I,{children:e.jsx(F,{placeholder:t.customer_id?A?"Loading bookings…":O.length?"Select booking (optional)":"No active bookings":"Select customer first"})}),e.jsx(B,{children:O.map(s=>{const l=s.room_label?`${s.room_label} • ${s.status} • ${new Date(s.checkin_at).toLocaleDateString()} - ${new Date(s.checkout_at).toLocaleDateString()}`:`Booking #${s.id} • ${s.status}`;return e.jsx(j,{value:String(s.id),children:l},s.id)})})]}),$&&e.jsx("p",{className:"text-xs text-red-500",children:$}),!$&&t.customer_id&&O.length===0&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"This customer has no active bookings. You may leave it blank."}),!t.customer_id&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"Pick a customer to choose a booking."})]})]}),e.jsx("fieldset",{disabled:!_,children:e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"grid grid-cols-4 items-start gap-4",children:[e.jsx(J,{className:"text-right pt-2",children:"Services *"}),e.jsxs("div",{className:"col-span-3 space-y-2",children:[v.map((s,l)=>{const c=m.find(p=>p.id===parseInt(s.id)),x=Ss(c),R=c?.type==="selectable",Q=c?.type==="per_unit",L=c?.unit_name||"",U=R&&!s?.details?.package,z=Q&&(s?.details?.weight===void 0||s?.details?.weight===null||s?.details?.weight===""||Number.isNaN(Number(s?.details?.weight)));return e.jsxs("div",{className:"border rounded p-3 space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h4",{className:"font-medium",children:["Service #",l+1]}),v.length>1&&e.jsx(P,{type:"button",variant:"outline",size:"sm",onClick:()=>S(l),children:e.jsx(Ce,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"grid grid-cols-12 gap-2",children:[e.jsx("div",{className:"col-span-7",children:e.jsxs(E,{value:s.id,onValueChange:p=>b(l,"id",p),children:[e.jsx(I,{children:e.jsx(F,{placeholder:"Select service"})}),e.jsx(B,{children:m.map(p=>e.jsx(j,{value:p.id.toString(),children:p.name},p.id))})]})}),e.jsx("div",{className:"col-span-5",children:e.jsx(ue,{type:"number",min:"1",placeholder:"Quantity",value:s.quantity,onChange:p=>b(l,"quantity",parseInt(p.target.value)||1)})})]}),c&&e.jsxs(e.Fragment,{children:[R&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs(E,{value:s?.details?.package||"",onValueChange:p=>o(l,"package",p),children:[e.jsx(I,{children:e.jsx(F,{placeholder:"Select option"})}),e.jsx(B,{children:x.map((p,X)=>e.jsxs(j,{value:p.name,children:[p.name," — ",Pe(Number(p.price))]},X))})]}),U?e.jsx("p",{className:"text-xs text-red-500",children:"Option is required for this service."}):e.jsx("p",{className:"text-xs text-muted-foreground",children:"Choose package/variant."})]}),Q&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ue,{type:"number",min:"0",step:"0.01",placeholder:L?`Amount (${L})`:"Amount",value:s?.details?.weight??"",onChange:p=>o(l,"weight",p.target.value===""?"":parseFloat(p.target.value)||0)}),L&&e.jsx("span",{className:"text-sm text-muted-foreground",children:L})]}),z?e.jsx("p",{className:"text-xs text-red-500",children:L?`${L} is required.`:"Amount is required."}):e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Enter the ",L||"amount"," for this service."]})]})]})]},l)}),e.jsxs(P,{type:"button",variant:"outline",size:"sm",onClick:y,className:"mt-2",children:[e.jsx(ke,{className:"h-4 w-4 mr-1"})," Add Service"]}),i.services&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:i.services})]})]})})}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(J,{className:"text-right",children:"Promotion"}),e.jsxs("div",{className:"col-span-3 space-y-2",children:[e.jsxs(E,{value:t.promotion_id||"",onValueChange:s=>r("promotion_id",s),disabled:g||C.length===0,children:[e.jsx(I,{children:e.jsx(F,{placeholder:g?"Checking promotions…":C.length?"Select a promotion":"No promotion available"})}),e.jsx(B,{children:C.map(s=>e.jsx(j,{value:String(s.id),children:_s(s,D)},s.id))})]}),i.promotion_id&&e.jsx("p",{className:"text-red-500 text-sm",children:i.promotion_id})]})]})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(J,{htmlFor:"status",className:"text-right",children:"Status *"}),e.jsxs(E,{value:t.status,onValueChange:s=>r("status",s),children:[e.jsx(I,{className:"col-span-3",children:e.jsx(F,{placeholder:"Select status"})}),e.jsxs(B,{children:[e.jsx(j,{value:"pending",children:"Pending"}),e.jsx(j,{value:"paid",children:"Paid"}),e.jsx(j,{value:"cancelled",children:"Cancelled"})]})]}),i.status&&e.jsx("p",{className:"text-red-500 text-sm col-span-4 text-right",children:i.status})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(J,{htmlFor:"payment_preference",className:"text-right",children:"Payment Method *"}),e.jsxs(E,{value:t.payment_preference,onValueChange:s=>r("payment_preference",s),disabled:!_,children:[e.jsx(I,{className:"col-span-3",children:e.jsx(F,{placeholder:"Select payment method"})}),e.jsxs(B,{children:[e.jsx(j,{value:"cash",children:"Cash"}),e.jsx(j,{value:"online",children:"Online"})]})]}),i.payment_preference&&e.jsx("p",{className:"text-red-500 text-sm col-span-4 text-right",children:i.payment_preference})]})]})};function ws(){const{orders:t,customers:r,services:i,filters:d,flash:m,totals:v}=Ke().props,b=[...new Set(r.map(a=>a.passport_country).filter(Boolean))],[o,y]=h.useState(d.search||""),[S,_]=h.useState(d.status||"all"),[T,C]=h.useState(d.payment_preference||"all"),[g,k]=h.useState(d.country||"all"),[D,O]=h.useState(d.sort_by||"created_at"),[N,A]=h.useState(d.sort_direction||"desc"),[q,$]=h.useState(!1),[V,s]=h.useState(!1),[l,c]=h.useState(!1),[x,R]=h.useState(null),[Q,L]=h.useState([]),[U,z]=h.useState([{id:"",quantity:1,details:{}}]),[p,X]=h.useState([]),[Te,K]=h.useState(!1),$e=x?.status==="pending",{data:H,setData:G,post:Ee,put:Ie,processing:pe,errors:je,reset:se,clearErrors:ge}=Ye({customer_id:"",services:[{id:"",quantity:1,details:{}}],status:"pending",payment_preference:"cash",promotion_id:"",event_code:"",booking_id:""});h.useEffect(()=>{m?.success&&ee.success(m.success),m?.error&&ee.error(m.error)},[m]),h.useEffect(()=>{const a=setTimeout(Fe,500);return()=>clearTimeout(a)},[o,S,T,g,D,N]);const Fe=(a=1)=>{ne.get(route("orders.index"),{search:o,status:S==="all"?"":S,country:g==="all"?"":g,payment_preference:T==="all"?"":T,sort_by:D,sort_direction:N,per_page:d.per_page,page:a},{preserveState:!0,replace:!0})},Be=a=>{D===a?A(n=>n==="asc"?"desc":"asc"):(O(a),A("asc"))},Me=()=>{se(),ge(),z([{id:"",quantity:1,details:{}}]),X([]),G("status","pending"),$(!0)},qe=a=>{const n=a.services.map(u=>({id:u.id,quantity:u.pivot.quantity,details:JSON.parse(u.pivot.details||"{}")}));G({customer_id:a.customer_id,services:n,status:a.status,payment_preference:a.payment_preference,promotion_id:"",event_code:"",booking_id:a.booking_id||""}),z(n),ge(),X([]),R(a),s(!0)},Re=a=>{R(a),c(!0)},Le=a=>{a.preventDefault(),Ee(route("orders.store"),{onSuccess:()=>{$(!1),se()}})},Ue=a=>{a.preventDefault(),Ie(route("orders.update",x.id),{onSuccess:()=>{s(!1),se()}})},Ve=()=>{ne.delete(route("orders.destroy",x.id),{onSuccess:()=>c(!1)})},ze=()=>{y(""),_("all"),C("all"),k("all"),O("created_at"),A("desc")},He=a=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR"}).format(a||0),Ge=a=>{let n="secondary";switch(a){case"pending":n="warning";break;case"paid":n="success";break;case"cancelled":n="destructive";break;default:n="outline"}return e.jsx(me,{variant:n,className:"capitalize px-2 py-1 text-xs font-medium",children:a})},Xe=a=>{let n="secondary";switch(a){case"cash":n="purple";break;case"online":n="info";break;default:n="outline"}return e.jsx(me,{variant:n,className:"capitalize px-2 py-1 text-xs font-medium",children:a})},Je=a=>L(n=>n.includes(a)?n.filter(u=>u!==a):[...n,a]),fe=()=>{const a=[...U,{id:"",quantity:1,details:{}}];z(a),G("services",a)},ve=a=>{if(U.length<=1)return;const n=U.filter((u,f)=>f!==a);z(n),G("services",n)},Ne=(a,n,u)=>{const f=[...U];f[a]={...f[a],[n]:u},n==="id"&&(f[a].details={}),z(f),G("services",f)},be=(a,n,u)=>{const f=[...U];f[a].details={...f[a].details,[n]:u},z(f),G("services",f)};async function We({customerId:a,serviceIds:n,eventCode:u}={}){if(!a||!Array.isArray(n)||n.length===0)return X([]),{promotions:[]};K(!0);const f=document.querySelector('meta[name="csrf-token"]')?.content,Y=await fetch(route("promotions.checkEligibility"),{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":f,"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({customer_id:Number(a),service_ids:n.map(Number).filter(Boolean),event_code:u||null})});if(!Y.ok){K(!1);let Se=`HTTP ${Y.status}`;try{const Z=await Y.json();Z?.message&&(Se=Z.message),Z?.errors&&console.error("[checkEligibility] 422 errors:",Z.errors)}catch{}throw new Error(`Failed to check promotions: ${Se}`)}const ye=await Y.json();return X(ye?.promotions||[]),K(!1),ye}h.useEffect(()=>{if(!q)return;const a=H.customer_id,n=(H.services||[]).map(f=>f.id).filter(Boolean),u=H.event_code||"";We({customerId:a,serviceIds:n,eventCode:u}).catch(f=>{console.error(f),ee.error("Failed to check promotions")})},[q,H.customer_id,JSON.stringify(H.services),H.event_code]);const Qe=a=>{if(!a)return null;const n=new URL(a),u=new URLSearchParams(n.search);return u.set("search",o),u.set("status",S==="all"?"":S),u.set("payment_preference",T==="all"?"":T),u.set("sort_by",D),u.set("sort_direction",N),`${n.pathname}?${u.toString()}`};return e.jsxs("div",{className:"container mx-auto px-4",children:[e.jsx(gs,{onAddOrder:Me,totals:v}),e.jsx(he,{className:"mb-8",children:e.jsxs(xe,{children:[e.jsx(fs,{searchTerm:o,setSearchTerm:y,selectedStatus:S,setSelectedStatus:_,selectedPaymentMethod:T,setSelectedPaymentMethod:C,selectedCountry:g,setSelectedCountry:k,clearFilters:ze,countries:b}),e.jsx(Ns,{orders:t?.data||[],expandedRows:Q,toggleRow:Je,openEditModal:qe,openDeleteModal:Re,getStatusBadge:Ge,getPaymentBadge:Xe,formatPrice:He,formatDate:a=>new Date(a).toLocaleDateString(),sortBy:D,sortDirection:N,handleSort:Be}),e.jsx(ys,{paginationData:t,buildPaginationUrl:Qe})]})}),e.jsx(re,{open:q,onOpenChange:a=>{$(a),a||(X([]),K(!1))},children:e.jsxs(ie,{className:"sm:max-w-[760px]",children:[e.jsxs(le,{children:[e.jsx(ce,{children:"Create New Order"}),e.jsx(oe,{children:"Add a new customer order"})]}),e.jsxs("form",{onSubmit:Le,children:[e.jsx(_e,{data:H,setData:G,errors:je,customers:r,services:i,orderServices:U,updateService:Ne,updateServiceDetail:be,addService:fe,removeService:ve,eligiblePromos:p,checkingPromo:Te}),e.jsx(de,{children:e.jsx(P,{type:"submit",disabled:pe,children:"Create Order"})})]})]})}),e.jsx(re,{open:V,onOpenChange:s,children:e.jsxs(ie,{className:"sm:max-w-[700px]",children:[e.jsxs(le,{children:[e.jsx(ce,{children:"Edit Order Status"}),e.jsx(oe,{children:"Only status and payment method can be changed."})]}),e.jsxs("form",{onSubmit:Ue,children:[e.jsx(_e,{data:H,setData:G,errors:je,customers:r,services:i,orderServices:U,updateService:Ne,updateServiceDetail:be,addService:fe,removeService:ve,isPending:$e,isStatusUpdateOnly:!0,eligiblePromos:[],checkingPromo:!1}),e.jsx(de,{children:e.jsx(P,{type:"submit",disabled:pe,children:"Update Order"})})]})]})}),e.jsx(bs,{isOpen:l,onOpenChange:c,onConfirm:Ve,order:x})]})}ws.layout=t=>e.jsx(ls,{children:t});export{ws as default};
